<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracy's Wine Stash</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Lato:wght@300;400;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Light Theme (Default) */
        :root {
            --bg-primary: #2d2d2d;
            --bg-secondary: #3a3a3a;
            --card-bg: #1a1a1a;
            --text-primary: #e8e4df;
            --text-secondary: #c4b5a0;
            --text-muted: #8e7f6f;
            --accent-primary: #c9a961;
            --accent-dark: #a68a4d;
            --accent-light: #d4bb7a;
            --border: #4a4a4a;
            --shadow: rgba(0, 0, 0, 0.3);
        }
        
        /* Dark Emerald Theme */
        :root[data-theme="emerald"] {
            --bg-primary: #0d4d4a;
            --bg-secondary: #115e59;
            --card-bg: #0f3d3a;
            --text-primary: #f5f1ed;
            --text-secondary: #d4bb7a;
            --text-muted: #a68a4d;
            --accent-primary: #c9a961;
            --accent-dark: #8e7f6f;
            --accent-light: #e8dcc5;
            --border: #1a6b66;
            --shadow: rgba(0, 0, 0, 0.4);
        }
        
        body { 
            font-family: 'Lato', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg-primary); 
            min-height: 100vh; 
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s ease;
        }
        
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        .header { 
            background: var(--card-bg); 
            box-shadow: 0 4px 12px var(--shadow); 
            padding: 28px 32px; 
            margin-bottom: 24px; 
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .header h1 { 
            color: var(--accent-primary); 
            font-family: 'Cormorant Garamond', serif;
            font-size: 42px; 
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .theme-toggle {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            background: var(--accent-primary);
            color: var(--card-bg);
        }
        
        .stats-table {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 2fr 3fr;
            gap: 20px;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .stat-label {
            color: var(--text-muted);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }
        
        .stat-value {
            color: var(--accent-primary);
            font-size: 28px;
            font-weight: 700;
            font-family: 'Cormorant Garamond', serif;
        }
        
        .stat-breakdown {
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 8px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .stat-row:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .stat-row-label {
            color: var(--text-muted);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-row-value {
            color: var(--accent-primary);
            font-size: 20px;
            font-weight: 700;
            font-family: 'Cormorant Garamond', serif;
        }
        
        .stat-row-sub {
            color: var(--text-secondary);
            font-size: 12px;
            margin-top: 2px;
        }
        
        /* Country table styling */
        .country-table {
            width: 100%;
            margin-top: 8px;
            border-collapse: collapse;
        }
        
        .country-table th {
            color: var(--text-muted);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 4px;
            border-bottom: 1px solid var(--border);
            text-align: left;
        }
        
        .country-table td {
            color: var(--text-secondary);
            font-size: 12px;
            padding: 6px 4px;
            border-bottom: 1px solid rgba(74, 74, 74, 0.3);
        }
        
        .country-table tr:last-child td {
            border-bottom: none;
        }
        
        .header-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .controls-wrapper {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .controls-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 12px;
        }
        
        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        /* Food pairing checkboxes */
        .food-pairing-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 12px;
        }
        
        .food-checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .food-checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }
        
        .food-checkbox-wrapper label {
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            user-select: none;
        }
        
        .controls-row input, .controls-row select, .filter-section select { 
            padding: 12px 16px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s;
        }
        
        .controls-row input:focus, .controls-row select:focus, .filter-section select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(201, 169, 97, 0.1);
        }
        
        .btn { 
            padding: 12px 24px; 
            background: var(--accent-primary); 
            color: var(--card-bg); 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600;
            transition: all 0.2s;
            font-family: 'Lato', sans-serif;
        }
        
        .btn:hover { 
            background: var(--accent-dark); 
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow);
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .wine-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 20px; 
            margin-top: 20px;
        }
        
        .wine-card { 
            background: var(--card-bg); 
            border: 1px solid var(--border);
            border-radius: 12px; 
            padding: 24px; 
            box-shadow: 0 2px 8px var(--shadow);
            transition: all 0.3s;
        }
        
        .wine-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px var(--shadow);
            border-color: var(--accent-primary);
        }
        
        .wine-card.expanded {
            grid-column: span 2;
        }
        
        .wine-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .wine-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid var(--border);
            flex-shrink: 0;
        }
        
        .wine-image-placeholder {
            width: 80px;
            height: 80px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 12px;
            flex-shrink: 0;
        }
        
        .wine-title-section {
            flex: 1;
        }
        
        .wine-name { 
            color: var(--accent-primary); 
            font-size: 20px; 
            font-weight: 600;
            margin-bottom: 4px;
            font-family: 'Cormorant Garamond', serif;
        }
        
        .wine-producer {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .wine-meta { 
            color: var(--text-muted); 
            font-size: 13px; 
            margin-bottom: 12px;
        }
        
        .wine-type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .wine-type-badge.red {
            background: rgba(139, 0, 0, 0.2);
            color: #ff6b6b;
            border: 1px solid rgba(139, 0, 0, 0.3);
        }
        
        .wine-type-badge.white {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd93d;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .wine-type-badge.sparkling {
            background: rgba(173, 216, 230, 0.2);
            color: #87ceeb;
            border: 1px solid rgba(173, 216, 230, 0.3);
        }
        
        .wine-type-badge.fortified,
        .wine-type-badge.dessert {
            background: rgba(218, 112, 214, 0.2);
            color: #da70d6;
            border: 1px solid rgba(218, 112, 214, 0.3);
        }
        
        /* Score badge on wine tile */
        .wine-score-badge {
            display: inline-block;
            background: var(--accent-primary);
            color: var(--card-bg);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 700;
            margin-left: 8px;
        }
        
        .wine-details {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .wine-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .wine-detail-label {
            color: var(--text-muted);
            font-weight: 600;
        }
        
        .wine-detail-value {
            color: var(--text-secondary);
        }
        
        .wine-notes {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .wine-notes-title {
            color: var(--accent-primary);
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .wine-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
        
        .wine-actions .btn {
            flex: 1;
            padding: 10px 16px;
            font-size: 13px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal.active { display: flex; align-items: center; justify-content: center; }
        
        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px var(--shadow);
        }
        
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            color: var(--accent-primary);
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'Lato', sans-serif;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(201, 169, 97, 0.1);
        }
        
        .modal-actions {
            padding: 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
            font-size: 16px;
        }
        
        @media (max-width: 768px) {
            .wine-grid {
                grid-template-columns: 1fr;
            }
            
            .wine-card.expanded {
                grid-column: span 1;
            }
            
            .controls-row {
                grid-template-columns: 1fr;
            }
            
            .filter-section {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 32px;
            }
            
            .food-pairing-filters {
                grid-template-columns: 1fr 1fr;
            }
        }
        /* ===== AI SOMMELIER CHATBOT ===== */
        .chat-fab {
            position: fixed;
            bottom: 28px;
            right: 28px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent-primary);
            color: var(--card-bg);
            border: none;
            cursor: pointer;
            font-size: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            z-index: 2000;
            transition: all 0.3s ease;
        }
        .chat-fab:hover {
            background: var(--accent-dark);
            transform: scale(1.1);
            box-shadow: 0 6px 28px rgba(0,0,0,0.5);
        }
        .chat-fab-label {
            position: absolute;
            right: 70px;
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            white-space: nowrap;
            border: 1px solid var(--border);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .chat-fab:hover .chat-fab-label { opacity: 1; }

        .chat-panel {
            position: fixed;
            bottom: 100px;
            right: 28px;
            width: 420px;
            max-height: 70vh;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.5);
            z-index: 1999;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: scale(0.9) translateY(20px);
            opacity: 0;
            pointer-events: none;
            transition: all 0.25s ease;
        }
        .chat-panel.open {
            transform: scale(1) translateY(0);
            opacity: 1;
            pointer-events: all;
        }
        .chat-panel-header {
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .chat-panel-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
            color: var(--accent-primary);
            font-weight: 600;
        }
        .chat-panel-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .chat-close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 22px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .chat-close-btn:hover { color: var(--text-primary); }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 200px;
        }
        .chat-message {
            display: flex;
            flex-direction: column;
            max-width: 88%;
        }
        .chat-message.user { align-self: flex-end; }
        .chat-message.assistant { align-self: flex-start; }
        .chat-bubble {
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
        }
        .chat-message.user .chat-bubble {
            background: var(--accent-primary);
            color: var(--card-bg);
            border-bottom-right-radius: 4px;
        }
        .chat-message.assistant .chat-bubble {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }
        .chat-sender {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
            padding: 0 4px;
        }
        .chat-message.user .chat-sender { text-align: right; }
        .chat-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 0 16px 12px;
            flex-shrink: 0;
        }
        .chat-suggestion-chip {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .chat-suggestion-chip:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        .chat-input-row {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        .chat-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 24px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'Lato', sans-serif;
            outline: none;
            resize: none;
            max-height: 80px;
            line-height: 1.4;
        }
        .chat-input:focus { border-color: var(--accent-primary); }
        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-primary);
            border: none;
            color: var(--card-bg);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .chat-send-btn:hover { background: var(--accent-dark); }
        .chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .chat-thinking {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            border-bottom-left-radius: 4px;
            width: fit-content;
        }
        .chat-dot {
            width: 7px;
            height: 7px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: chatBounce 1.2s infinite;
        }
        .chat-dot:nth-child(2) { animation-delay: 0.2s; }
        .chat-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes chatBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }
        @media (max-width: 768px) {
            .chat-panel {
                width: calc(100vw - 24px);
                right: 12px;
                bottom: 90px;
                max-height: 65vh;
            }
            .chat-fab { bottom: 20px; right: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <h1>Tracy's Wine Stash</h1>
                <button class="theme-toggle" onclick="toggleTheme()">Toggle Theme</button>
            </div>
            
            <div class="stats-table" id="statsTable">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Collection Summary</div>
                        <div class="stat-row">
                            <span class="stat-row-label">Total Wines</span>
                            <div>
                                <div class="stat-row-value" id="totalWines">0</div>
                                <div class="stat-row-sub" id="wineTypeBreakdown"></div>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Total Bottles</span>
                            <div class="stat-row-value" id="totalBottles">0</div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Avg Score</span>
                            <div>
                                <div class="stat-row-value" id="averageScore">N/A</div>
                                <div class="stat-row-sub" id="scoreBreakdown"></div>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Total Value</span>
                            <div>
                                <div class="stat-row-value" id="totalValue">$0</div>
                                <div class="stat-row-sub" id="valueBreakdown"></div>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">By Country & Type</div>
                        <div id="countryBreakdown"></div>
                    </div>
                </div>
            </div>
            
            <div class="header-actions">
                <button class="btn" onclick="openAddModal()">Add Wine</button>
                <button class="btn btn-secondary" onclick="openCsvModal()">Import CSV</button>
                <button class="btn btn-secondary" onclick="exportCsv()">Export CSV</button>
            </div>
            
            <div class="controls-wrapper">
                <div class="controls-row">
                    <input type="text" id="searchInput" placeholder="Search wines..." onkeyup="filterWines()">
                    <select id="wineTypeFilter" onchange="filterWines()">
                        <option value="">All Wine Types</option>
                    </select>
                    <select id="sortBy" onchange="sortWines()">
                        <option value="producer">Producer</option>
                        <option value="vintage">Vintage</option>
                        <option value="drinkFrom">Drink From</option>
                        <option value="score">Score</option>
                    </select>
                </div>
                
                <div class="filter-section">
                    <select id="grapeFilter" onchange="filterWines()">
                        <option value="">All Grapes</option>
                    </select>
                    <select id="countryFilter" onchange="filterWines()">
                        <option value="">All Countries</option>
                    </select>
                    <select id="quantityFilter" onchange="filterWines()">
                        <option value="">All Quantities</option>
                        <option value="in-stock">In Stock (>0)</option>
                        <option value="empty">Empty (0)</option>
                        <option value="low">Low Stock (1-3)</option>
                        <option value="medium">Medium Stock (4-6)</option>
                        <option value="high">High Stock (>6)</option>
                    </select>
                </div>
                
                <!-- Food Pairing Filters -->
                <div class="food-pairing-filters">
                    <div class="food-checkbox-wrapper">
                        <input type="checkbox" id="foodRedMeat" onchange="filterWines()">
                        <label for="foodRedMeat">Red Meat</label>
                    </div>
                    <div class="food-checkbox-wrapper">
                        <input type="checkbox" id="foodWhiteMeat" onchange="filterWines()">
                        <label for="foodWhiteMeat">White Meat</label>
                    </div>
                    <div class="food-checkbox-wrapper">
                        <input type="checkbox" id="foodSeafood" onchange="filterWines()">
                        <label for="foodSeafood">Seafood</label>
                    </div>
                    <div class="food-checkbox-wrapper">
                        <input type="checkbox" id="foodSpicy" onchange="filterWines()">
                        <label for="foodSpicy">Spicy Food</label>
                    </div>
                    <div class="food-checkbox-wrapper">
                        <input type="checkbox" id="foodPasta" onchange="filterWines()">
                        <label for="foodPasta">Pasta</label>
                    </div>
                    <div class="food-checkbox-wrapper">
                        <input type="checkbox" id="foodDessert" onchange="filterWines()">
                        <label for="foodDessert">Dessert</label>
                    </div>
                    <div class="food-checkbox-wrapper">
                        <input type="checkbox" id="foodCheese" onchange="filterWines()">
                        <label for="foodCheese">Cheese</label>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="wineGrid" class="wine-grid">
            <div class="loading">Loading wines...</div>
        </div>
    </div>

    <!-- Add Wine Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Wine</h2>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Wine Name *</label>
                    <input type="text" id="addWineName" required>
                </div>
                <div class="form-group">
                    <label>Producer *</label>
                    <input type="text" id="addProducer" required>
                </div>
                <div class="form-group">
                    <label>Vintage *</label>
                    <input type="number" id="addVintage" required>
                </div>
                <div class="form-group">
                    <label>Wine Type *</label>
                    <select id="addWineType" required>
                        <option value="">Select type...</option>
                        <option value="Red">Red</option>
                        <option value="White">White</option>
                        <option value="Sparkling">Sparkling</option>
                        <option value="Fortified">Fortified</option>
                        <option value="Dessert">Dessert</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Varietal</label>
                    <input type="text" id="addVarietal" placeholder="e.g., Pinot Noir, Cabernet Blend">
                </div>
                <div class="form-group">
                    <label>Region</label>
                    <input type="text" id="addRegion">
                </div>
                <div class="form-group">
                    <label>Sub-Region</label>
                    <input type="text" id="addSubRegion">
                </div>
                <div class="form-group">
                    <label>Country</label>
                    <input type="text" id="addCountry">
                </div>
                <div class="form-group">
                    <label>Quantity *</label>
                    <input type="number" id="addQuantity" value="1" required>
                </div>
                <div class="form-group">
                    <label>Drink From (Year)</label>
                    <input type="number" id="addDrinkFrom">
                </div>
                <div class="form-group">
                    <label>Drink To (Year)</label>
                    <input type="number" id="addDrinkTo">
                </div>
                <div class="form-group">
                    <label>Storage Location</label>
                    <input type="text" id="addLocation">
                </div>
                <div class="form-group">
                    <label>Community Score (0-100)</label>
                    <input type="number" id="addCommunityScore" min="0" max="100">
                </div>
                <div class="form-group">
                    <label>Professional Score (0-100)</label>
                    <input type="number" id="addPersonalScore" min="0" max="100">
                </div>
                <div class="form-group">
                    <label>Current Value ($)</label>
                    <input type="number" id="addCurrentValue" min="0">
                </div>
                <div class="form-group">
                    <label>Tasting Notes</label>
                    <textarea id="addTastingNotes"></textarea>
                </div>
                <div class="form-group">
                    <label>Personal Notes</label>
                    <textarea id="addPersonalNotes"></textarea>
                </div>
                <div class="form-group">
                    <label>Food Pairings</label>
                    <input type="text" id="addFoodPairings" placeholder="e.g., Beef; Lamb; Game">
                </div>
                <div class="form-group">
                    <label>Photo URL</label>
                    <input type="text" id="addPhotoUrl" placeholder="https://...">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                <button class="btn" onclick="addWine()">Add Wine</button>
            </div>
        </div>
    </div>

    <!-- Edit Wine Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Wine</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editWineId">
                <div class="form-group">
                    <label>Wine Name *</label>
                    <input type="text" id="editWineName" required>
                </div>
                <div class="form-group">
                    <label>Producer *</label>
                    <input type="text" id="editProducer" required>
                </div>
                <div class="form-group">
                    <label>Vintage *</label>
                    <input type="number" id="editVintage" required>
                </div>
                <div class="form-group">
                    <label>Wine Type *</label>
                    <select id="editWineType" required>
                        <option value="Red">Red</option>
                        <option value="White">White</option>
                        <option value="Sparkling">Sparkling</option>
                        <option value="Fortified">Fortified</option>
                        <option value="Dessert">Dessert</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Varietal</label>
                    <input type="text" id="editVarietal">
                </div>
                <div class="form-group">
                    <label>Region</label>
                    <input type="text" id="editRegion">
                </div>
                <div class="form-group">
                    <label>Sub-Region</label>
                    <input type="text" id="editSubRegion">
                </div>
                <div class="form-group">
                    <label>Country</label>
                    <input type="text" id="editCountry">
                </div>
                <div class="form-group">
                    <label>Quantity *</label>
                    <input type="number" id="editQuantity" required>
                </div>
                <div class="form-group">
                    <label>Drink From (Year)</label>
                    <input type="number" id="editDrinkFrom">
                </div>
                <div class="form-group">
                    <label>Drink To (Year)</label>
                    <input type="number" id="editDrinkTo">
                </div>
                <div class="form-group">
                    <label>Storage Location</label>
                    <input type="text" id="editLocation">
                </div>
                <div class="form-group">
                    <label>Community Score (0-100)</label>
                    <input type="number" id="editCommunityScore" min="0" max="100">
                </div>
                <div class="form-group">
                    <label>Professional Score (0-100)</label>
                    <input type="number" id="editPersonalScore" min="0" max="100">
                </div>
                <div class="form-group">
                    <label>Current Value ($)</label>
                    <input type="number" id="editCurrentValue" min="0">
                </div>
                <div class="form-group">
                    <label>Tasting Notes</label>
                    <textarea id="editTastingNotes"></textarea>
                </div>
                <div class="form-group">
                    <label>Personal Notes</label>
                    <textarea id="editPersonalNotes"></textarea>
                </div>
                <div class="form-group">
                    <label>Food Pairings</label>
                    <input type="text" id="editFoodPairings">
                </div>
                <div class="form-group">
                    <label>Photo URL</label>
                    <input type="text" id="editPhotoUrl">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn" onclick="updateWine()">Update Wine</button>
            </div>
        </div>
    </div>

    <!-- CSV Import Modal -->
    <div id="csvModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import CSV</h2>
                <button class="modal-close" onclick="closeCsvModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Paste CSV Data</label>
                    <textarea id="csvData" placeholder="Paste your CSV data here..." style="min-height: 300px;"></textarea>
                    <p style="color: var(--text-muted); font-size: 12px; margin-top: 8px;">
                        First row should contain headers. Columns: wineName, producer, vintage, wineType, varietal, region, subRegion, country, quantity, drinkFrom, drinkTo, location, tastingNotes, personalNotes, foodPairings, photoUrl
                    </p>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeCsvModal()">Cancel</button>
                <button class="btn" onclick="importCsv()">Import</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzzwhBtsTYoT04KPGy6QGur4BfsDAQjjRdL5DInfFLTLnbOT5SKrSf4w3W8jFCPfJ-kvQ/exec';
        let allWines = [];
        let expandedCards = new Set();

        // Food pairing category keywords for intelligent matching
        const FOOD_CATEGORIES = {
            redMeat: ['beef', 'lamb', 'venison', 'game', 'deer', 'duck', 'steak', 'ribs', 'short rib', 'bison', 'elk', 'wild boar', 'veal'],
            whiteMeat: ['chicken', 'turkey', 'pork', 'poultry'],
            seafood: ['fish', 'salmon', 'tuna', 'shrimp', 'lobster', 'crab', 'shellfish', 'scallops', 'oysters', 'mussels', 'clams', 'prawns', 'seafood', 'anchovy', 'sardine', 'sea bass', 'halibut', 'cod'],
            spicy: ['spicy', 'curry', 'chili', 'thai', 'indian', 'szechuan', 'hot', 'jalapeño', 'pepper'],
            pasta: ['pasta', 'spaghetti', 'lasagna', 'ravioli', 'carbonara', 'bolognese', 'penne', 'linguine', 'fettuccine', 'tagliatelle'],
            dessert: ['chocolate', 'dessert', 'cake', 'tart', 'fruit dessert', 'sweet', 'pudding', 'pie', 'pastry', 'soufflé', 'crème'],
            cheese: ['cheese', 'cheddar', 'brie', 'goat cheese', 'blue cheese', 'parmesan', 'aged cheese']
        };

        // Helper function to normalize wine data field names
        function normalizeWine(wine) {
            if (!wine) {
                console.error('normalizeWine received null/undefined wine');
                return null;
            }
            
            try {
                return {
                    id: wine.id || '',
                    wineName: wine.wineName || '',
                    producer: wine.producer || '',
                    vintage: wine.vintage || '',
                    wineType: wine.wineType || wine.type || wine.color || '',
                    varietal: wine.varietal || '',
                    masterVarietal: wine.masterVarietal || '',
                    designation: wine.designation || '',
                    vineyard: wine.vineyard || '',
                    region: wine.region || '',
                    subRegion: wine.subRegion || '',
                    appellation: wine.appellation || '',
                    country: wine.country || '',
                    quantity: parseInt(wine.quantity) || 0,
                    quantityConsumed: parseInt(wine.quantityConsumed) || 0,
                    size: wine.size || '',
                    drinkFrom: wine.drinkFrom || wine.drinkWindowStart || '',
                    drinkTo: wine.drinkTo || wine.drinkWindowEnd || '',
                    windowSource: wine.windowSource || '',
                    location: wine.location || wine.storageLocation || '',
                    purchaseDate: wine.purchaseDate || '',
                    purchasePrice: wine.purchasePrice || '',
                    currentValue: wine.currentValue || '',
                    communityScore: wine.communityScore || '',
                    communityNotes: wine.communityNotes || '',
                    personalScore: wine.personalScore || '',
                    tastingNotes: wine.tastingNotes || '',
                    personalNotes: wine.personalNotes || '',
                    foodPairings: wine.foodPairings || '',
                    photoUrl: wine.photoUrl || '',
                    iWine: wine.iWine || '',
                    dateAdded: wine.dateAdded || ''
                };
            } catch (error) {
                console.error('Error normalizing wine:', error, wine);
                return null;
            }
        }

        // Helper function to check if wine matches a food pairing category
        function matchesFoodCategory(wine, category) {
            if (!wine.foodPairings) return false;
            const pairings = wine.foodPairings.toLowerCase();
            const keywords = FOOD_CATEGORIES[category] || [];
            return keywords.some(keyword => pairings.includes(keyword.toLowerCase()));
        }

        // Theme Toggle
        function toggleTheme() {
            const root = document.documentElement;
            const currentTheme = root.getAttribute('data-theme');
            const newTheme = currentTheme === 'emerald' ? '' : 'emerald';
            root.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Load saved theme
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            }
            loadWines();
        });

        async function loadWines() {
            try {
                const response = await fetch(`${API_URL}?action=getAll`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (!data.wines || !Array.isArray(data.wines)) {
                    throw new Error('Invalid response format');
                }
                
                // Normalize all wines to use consistent field names
                allWines = data.wines.map(wine => normalizeWine(wine)).filter(wine => wine !== null);
                
                // Debug logging
                console.log('Loaded wines:', allWines.length);
                if (data.wines.length > 0) {
                    console.log('=== ORIGINAL FIELD NAMES FROM GOOGLE SHEET ===');
                    console.log(Object.keys(data.wines[0]).join(', '));
                    console.log('=== SAMPLE ORIGINAL DATA ===');
                    console.log(data.wines[0]);
                }
                
                populateFilters();
                updateStatistics();
                displayWines(allWines);
            } catch (error) {
                console.error('Error loading wines:', error);
                document.getElementById('wineGrid').innerHTML = 
                    `<div class="loading">Failed to load wines. Error: ${error.message}<br><br>Please check console for details.</div>`;
            }
        }

        function populateFilters() {
            // Populate grape filter
            const grapes = new Set();
            allWines.forEach(wine => {
                if (wine.varietal && wine.varietal.trim()) {
                    // Handle blends - split by comma, slash, semicolon, or "and"
                    const varietals = wine.varietal.split(/[,\/;]|and/i).map(v => v.trim());
                    varietals.forEach(v => {
                        if (v && v.length > 0) grapes.add(v);
                    });
                }
            });
            
            const grapeFilter = document.getElementById('grapeFilter');
            grapeFilter.innerHTML = '<option value="">All Grapes</option>';
            Array.from(grapes).sort().forEach(grape => {
                grapeFilter.innerHTML += `<option value="${grape}">${grape}</option>`;
            });

            // Populate country filter
            const countries = new Set();
            allWines.forEach(wine => {
                if (wine.country && wine.country.trim()) {
                    countries.add(wine.country.trim());
                }
            });
            
            const countryFilter = document.getElementById('countryFilter');
            countryFilter.innerHTML = '<option value="">All Countries</option>';
            Array.from(countries).sort().forEach(country => {
                countryFilter.innerHTML += `<option value="${country}">${country}</option>`;
            });

            // Populate wine type filter dynamically
            const wineTypes = new Set();
            allWines.forEach(wine => {
                if (wine.wineType && wine.wineType.trim()) {
                    wineTypes.add(wine.wineType.trim());
                }
            });
            
            const wineTypeFilter = document.getElementById('wineTypeFilter');
            wineTypeFilter.innerHTML = '<option value="">All Wine Types</option>';
            Array.from(wineTypes).sort().forEach(type => {
                wineTypeFilter.innerHTML += `<option value="${type}">${type}</option>`;
            });
        }

        function updateStatistics() {
            // Total wines (with bottles > 0)
            const winesInStock = allWines.filter(w => {
                const qty = parseInt(w.quantity) || 0;
                return qty > 0;
            });
            document.getElementById('totalWines').textContent = winesInStock.length;

            // Total bottles - more robust parsing
            const totalBottles = allWines.reduce((sum, wine) => {
                const qty = parseInt(wine.quantity) || 0;
                return sum + qty;
            }, 0);
            document.getElementById('totalBottles').textContent = totalBottles;

            // Breakdown by type (case-insensitive)
            const typeMap = {};
            winesInStock.forEach(wine => {
                const type = (wine.wineType || '').trim();
                if (type) {
                    typeMap[type] = (typeMap[type] || 0) + 1;
                }
            });
            
            const typeBreakdown = Object.entries(typeMap)
                .sort((a, b) => b[1] - a[1])
                .map(([type, count]) => `${type}: ${count}`)
                .join(' | ');
            
            document.getElementById('wineTypeBreakdown').innerHTML = typeBreakdown || 'No data';

            // Calculate average score - uses professionalScore first, communityScore as fallback - ROUNDED TO WHOLE NUMBER
            const winesWithScores = winesInStock.filter(w => {
                const score = parseFloat(w.personalScore) || parseFloat(w.communityScore) || 0;
                return score > 0;
            });

            if (winesWithScores.length > 0) {
                const totalScore = winesWithScores.reduce((sum, wine) => {
                    const score = parseFloat(wine.personalScore) || parseFloat(wine.communityScore) || 0;
                    return sum + score;
                }, 0);
                const avgScore = Math.round(totalScore / winesWithScores.length);
                document.getElementById('averageScore').textContent = avgScore;
                document.getElementById('scoreBreakdown').textContent = `${winesWithScores.length} rated`;
            } else {
                document.getElementById('averageScore').textContent = 'N/A';
                document.getElementById('scoreBreakdown').textContent = 'None rated';
            }

            // Calculate total value - ROUNDED TO WHOLE NUMBER
            const winesWithValue = winesInStock.filter(w => {
                const value = parseFloat(w.currentValue);
                return value > 0;
            });

            if (winesWithValue.length > 0) {
                const totalValue = winesWithValue.reduce((sum, wine) => {
                    const value = parseFloat(wine.currentValue) || 0;
                    const qty = parseInt(wine.quantity) || 0;
                    return sum + (value * qty);
                }, 0);
                const roundedValue = Math.round(totalValue);
                document.getElementById('totalValue').textContent = `$${roundedValue.toLocaleString()}`;
                document.getElementById('valueBreakdown').textContent = `${winesWithValue.length} valued`;
            } else {
                document.getElementById('totalValue').textContent = '$0';
                document.getElementById('valueBreakdown').textContent = 'None valued';
            }

            // Country breakdown by wine type - as a table
            const countryMap = {};
            winesInStock.forEach(wine => {
                if (wine.country && wine.country.trim()) {
                    const country = wine.country.trim();
                    const type = (wine.wineType || 'Unknown').trim();
                    
                    if (!countryMap[country]) {
                        countryMap[country] = { total: 0, types: {} };
                    }
                    countryMap[country].total++;
                    countryMap[country].types[type] = (countryMap[country].types[type] || 0) + 1;
                }
            });
            
            // Sort countries by total count
            const sortedCountries = Object.entries(countryMap)
                .sort((a, b) => b[1].total - a[1].total);
            
            // Create table HTML
            let tableHtml = '<table class="country-table">';
            tableHtml += '<thead><tr><th>Country</th><th>Total</th>';
            
            // Find all unique wine types
            const allTypes = new Set();
            sortedCountries.forEach(([_, data]) => {
                Object.keys(data.types).forEach(type => allTypes.add(type));
            });
            const sortedTypes = Array.from(allTypes).sort();
            
            // Add type headers
            sortedTypes.forEach(type => {
                tableHtml += `<th>${type}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';
            
            // Add rows
            sortedCountries.forEach(([country, data]) => {
                tableHtml += `<tr><td><strong>${country}</strong></td><td>${data.total}</td>`;
                sortedTypes.forEach(type => {
                    const count = data.types[type] || 0;
                    tableHtml += `<td>${count > 0 ? count : '-'}</td>`;
                });
                tableHtml += '</tr>';
            });
            
            tableHtml += '</tbody></table>';
            
            document.getElementById('countryBreakdown').innerHTML = tableHtml || 'No data';
        }

        function filterWines() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('wineTypeFilter').value;
            const grapeFilter = document.getElementById('grapeFilter').value;
            const countryFilter = document.getElementById('countryFilter').value;
            const quantityFilter = document.getElementById('quantityFilter').value;

            // Food pairing filters
            const foodFilters = {
                redMeat: document.getElementById('foodRedMeat').checked,
                whiteMeat: document.getElementById('foodWhiteMeat').checked,
                seafood: document.getElementById('foodSeafood').checked,
                spicy: document.getElementById('foodSpicy').checked,
                pasta: document.getElementById('foodPasta').checked,
                dessert: document.getElementById('foodDessert').checked,
                cheese: document.getElementById('foodCheese').checked
            };

            // Check if any food filters are active
            const hasFoodFilters = Object.values(foodFilters).some(v => v);

            let filtered = allWines.filter(wine => {
                // Search filter
                const searchMatch = !searchTerm || 
                    (wine.wineName && wine.wineName.toLowerCase().includes(searchTerm)) ||
                    (wine.producer && wine.producer.toLowerCase().includes(searchTerm)) ||
                    (wine.vintage && wine.vintage.toString().includes(searchTerm)) ||
                    (wine.varietal && wine.varietal.toLowerCase().includes(searchTerm)) ||
                    (wine.region && wine.region.toLowerCase().includes(searchTerm));

                // Type filter
                const typeMatch = !typeFilter || wine.wineType === typeFilter;

                // Grape filter (supports blends)
                const grapeMatch = !grapeFilter || 
                    (wine.varietal && wine.varietal.split(/[,\/;]|and/i).some(v => 
                        v.trim().toLowerCase() === grapeFilter.toLowerCase()
                    ));

                // Country filter
                const countryMatch = !countryFilter || wine.country === countryFilter;

                // Quantity filter
                let quantityMatch = true;
                const qty = parseInt(wine.quantity || 0);
                if (quantityFilter === 'in-stock') {
                    quantityMatch = qty > 0;
                } else if (quantityFilter === 'empty') {
                    quantityMatch = qty === 0;
                } else if (quantityFilter === 'low') {
                    quantityMatch = qty >= 1 && qty <= 3;
                } else if (quantityFilter === 'medium') {
                    quantityMatch = qty >= 4 && qty <= 6;
                } else if (quantityFilter === 'high') {
                    quantityMatch = qty > 6;
                }

                // Food pairing filter - if any checkbox is checked, wine must match at least one
                let foodMatch = true;
                if (hasFoodFilters) {
                    foodMatch = false;
                    for (const [category, isChecked] of Object.entries(foodFilters)) {
                        if (isChecked && matchesFoodCategory(wine, category)) {
                            foodMatch = true;
                            break;
                        }
                    }
                }

                return searchMatch && typeMatch && grapeMatch && countryMatch && quantityMatch && foodMatch;
            });

            displayWines(filtered);
        }

        function sortWines() {
            const sortBy = document.getElementById('sortBy').value;
            const filtered = Array.from(allWines);
            
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'vintage':
                        return (parseInt(b.vintage) || 0) - (parseInt(a.vintage) || 0);
                    case 'producer':
                        return (a.producer || '').localeCompare(b.producer || '');
                    case 'drinkFrom':
                        return (parseInt(a.drinkFrom) || 9999) - (parseInt(b.drinkFrom) || 9999);
                    case 'score':
                        // Sort by professional score first; fall back to community score (marked with *)
                        const scoreA = parseFloat(a.personalScore) || parseFloat(a.communityScore) || 0;
                        const scoreB = parseFloat(b.personalScore) || parseFloat(b.communityScore) || 0;
                        return scoreB - scoreA;
                    default:
                        return 0;
                }
            });
            
            displayWines(filtered);
        }

        function displayWines(wines) {
            const grid = document.getElementById('wineGrid');
            
            if (!wines || wines.length === 0) {
                grid.innerHTML = '<div class="loading">No wines found</div>';
                return;
            }

            grid.innerHTML = wines.map(wine => {
                if (!wine || !wine.id) {
                    console.error('Wine missing ID:', wine);
                    return '';
                }
                
                const wineId = String(wine.id);
                const isExpanded = expandedCards.has(wineId);
                const photoUrl = wine.photoUrl || '';
                const drinkFrom = wine.drinkFrom || '';
                const drinkTo = wine.drinkTo || '';
                
                // Get best available score - professionalScore first, community as fallback - ROUNDED TO WHOLE NUMBER
                const rawProfScore = parseFloat(wine.personalScore) || null;
                const rawCommScore = parseFloat(wine.communityScore) || null;
                const rawScore = rawProfScore || rawCommScore || null;
                const score = rawScore ? Math.round(rawScore) : null;
                const scoreLabel = rawScore ? (rawProfScore ? '' : '*') : '';
                
                return `
                    <div class="wine-card ${isExpanded ? 'expanded' : ''}" id="card-${wineId}">
                        <div class="wine-header">
                            ${photoUrl ? 
                                `<img src="${photoUrl}" alt="${wine.wineName || 'Wine'}" class="wine-image" onerror="this.style.display='none'">` :
                                `<div class="wine-image-placeholder">No Image</div>`
                            }
                            <div class="wine-title-section">
                                <div class="wine-name">${wine.wineName || 'Unnamed Wine'}</div>
                                <div class="wine-producer">${wine.producer || ''}</div>
                                <div class="wine-meta">
                                    <span class="wine-type-badge ${(wine.wineType || '').toLowerCase()}">${wine.wineType || ''}</span>
                                    ${wine.vintage || ''} ${wine.varietal ? '| ' + wine.varietal : ''}
                                    ${score ? `<span class="wine-score-badge" title="${scoreLabel ? 'Community score (no professional score available)' : 'Professional score'}">${score}${scoreLabel}</span>` : ''}
                                </div>
                            </div>
                        </div>

                        <div class="wine-details">
                            <div class="wine-detail-row">
                                <span class="wine-detail-label">Region:</span>
                                <span class="wine-detail-value">${wine.region || 'N/A'}${wine.subRegion ? ` - ${wine.subRegion}` : ''}</span>
                            </div>
                            <div class="wine-detail-row">
                                <span class="wine-detail-label">Country:</span>
                                <span class="wine-detail-value">${wine.country || 'N/A'}</span>
                            </div>
                            <div class="wine-detail-row">
                                <span class="wine-detail-label">Bottles:</span>
                                <span class="wine-detail-value">${wine.quantity || 0}</span>
                            </div>
                            ${drinkFrom || drinkTo ? `
                                <div class="wine-detail-row">
                                    <span class="wine-detail-label">Drink Window:</span>
                                    <span class="wine-detail-value">${drinkFrom || 'Now'} - ${drinkTo || 'Later'}</span>
                                </div>
                            ` : ''}
                            
                            ${wine.tastingNotes ? `
                                <div class="wine-notes">
                                    <div class="wine-notes-title">Tasting Notes</div>
                                    ${wine.tastingNotes}
                                </div>
                            ` : ''}
                            
                            ${isExpanded ? `
                                ${wine.designation ? `
                                    <div class="wine-detail-row">
                                        <span class="wine-detail-label">Designation:</span>
                                        <span class="wine-detail-value">${wine.designation}</span>
                                    </div>
                                ` : ''}
                                ${wine.vineyard ? `
                                    <div class="wine-detail-row">
                                        <span class="wine-detail-label">Vineyard:</span>
                                        <span class="wine-detail-value">${wine.vineyard}</span>
                                    </div>
                                ` : ''}
                                ${wine.appellation ? `
                                    <div class="wine-detail-row">
                                        <span class="wine-detail-label">Appellation:</span>
                                        <span class="wine-detail-value">${wine.appellation}</span>
                                    </div>
                                ` : ''}
                                ${wine.masterVarietal ? `
                                    <div class="wine-detail-row">
                                        <span class="wine-detail-label">Master Varietal:</span>
                                        <span class="wine-detail-value">${wine.masterVarietal}</span>
                                    </div>
                                ` : ''}
                                ${wine.size ? `
                                    <div class="wine-detail-row">
                                        <span class="wine-detail-label">Bottle Size:</span>
                                        <span class="wine-detail-value">${wine.size}</span>
                                    </div>
                                ` : ''}
                                ${wine.quantityConsumed ? `
                                    <div class="wine-detail-row">
                                        <span class="wine-detail-label">Consumed:</span>
                                        <span class="wine-detail-value">${wine.quantityConsumed} bottles</span>
                                    </div>
                                ` : ''}
                                ${wine.location ? `
                                    <div class="wine-detail-row">
                                        <span class="wine-detail-label">Storage Location:</span>
                                        <span class="wine-detail-value">${wine.location}</span>
                                    </div>
                                ` : ''}
                                ${wine.foodPairings ? `
                                    <div class="wine-detail-row">
                                        <span class="wine-detail-label">Food Pairings:</span>
                                        <span class="wine-detail-value">${wine.foodPairings}</span>
                                    </div>
                                ` : ''}
                                ${wine.purchaseDate ? `
                                    <div class="wine-detail-row">
                                        <span class="wine-detail-label">Purchase Date:</span>
                                        <span class="wine-detail-value">${wine.purchaseDate}</span>
                                    </div>
                                ` : ''}
                                ${wine.purchasePrice ? `
                                    <div class="wine-detail-row">
                                        <span class="wine-detail-label">Purchase Price:</span>
                                        <span class="wine-detail-value">${wine.purchasePrice}</span>
                                    </div>
                                ` : ''}
                                ${wine.currentValue ? `
                                    <div class="wine-detail-row">
                                        <span class="wine-detail-label">Current Value:</span>
                                        <span class="wine-detail-value">$${Math.round(parseFloat(wine.currentValue))}</span>
                                    </div>
                                ` : ''}
                                ${wine.communityScore ? `
                                    <div class="wine-detail-row">
                                        <span class="wine-detail-label">Community Score:</span>
                                        <span class="wine-detail-value">${Math.round(parseFloat(wine.communityScore))}/100</span>
                                    </div>
                                ` : ''}
                                ${wine.personalScore ? `
                                    <div class="wine-detail-row">
                                        <span class="wine-detail-label">Professional Score:</span>
                                        <span class="wine-detail-value">${Math.round(parseFloat(wine.personalScore))}/100</span>
                                    </div>
                                ` : ''}
                                ${wine.windowSource ? `
                                    <div class="wine-detail-row">
                                        <span class="wine-detail-label">Drink Window Source:</span>
                                        <span class="wine-detail-value">${wine.windowSource}</span>
                                    </div>
                                ` : ''}
                                ${wine.communityNotes ? `
                                    <div class="wine-notes">
                                        <div class="wine-notes-title">Community Notes</div>
                                        ${wine.communityNotes}
                                    </div>
                                ` : ''}
                                ${wine.personalNotes ? `
                                    <div class="wine-notes">
                                        <div class="wine-notes-title">Personal Notes</div>
                                        ${wine.personalNotes}
                                    </div>
                                ` : ''}
                            ` : ''}
                        </div>

                        <div class="wine-actions">
                            <button class="btn btn-secondary" onclick="window.toggleExpand('${wineId}')">
                                ${isExpanded ? 'Less' : 'More'}
                            </button>
                            <button class="btn btn-secondary" onclick="window.openEditModal('${wineId}')">Edit</button>
                            <button class="btn btn-secondary" onclick="window.deleteWine('${wineId}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleExpand(wineId) {
            console.log('toggleExpand called with ID:', wineId);
            console.log('Current expandedCards:', Array.from(expandedCards));
            
            const stringId = String(wineId);
            if (expandedCards.has(stringId)) {
                expandedCards.delete(stringId);
                console.log('Collapsed wine:', stringId);
            } else {
                expandedCards.add(stringId);
                console.log('Expanded wine:', stringId);
            }
            
            // Re-apply current filters to maintain filtered view
            const searchTerm = document.getElementById('searchInput').value;
            const hasFilters = searchTerm || 
                              document.getElementById('wineTypeFilter').value ||
                              document.getElementById('grapeFilter').value ||
                              document.getElementById('countryFilter').value ||
                              document.getElementById('quantityFilter').value ||
                              document.getElementById('foodRedMeat').checked ||
                              document.getElementById('foodWhiteMeat').checked ||
                              document.getElementById('foodSeafood').checked ||
                              document.getElementById('foodSpicy').checked ||
                              document.getElementById('foodPasta').checked ||
                              document.getElementById('foodDessert').checked ||
                              document.getElementById('foodCheese').checked;
            
            if (hasFilters) {
                filterWines();
            } else {
                displayWines(allWines);
            }
        }

        // Modal functions
        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
        }

        function openEditModal(wineId) {
            console.log('openEditModal called with ID:', wineId, 'Type:', typeof wineId);
            console.log('Available wine IDs:', allWines.map(w => ({ id: w.id, type: typeof w.id })));
            
            const stringId = String(wineId);
            const wine = allWines.find(w => String(w.id) === stringId);
            
            if (!wine) {
                console.error('Wine not found:', wineId);
                console.error('Searched for ID:', stringId);
                console.error('Available wines:', allWines.map(w => w.id));
                alert('Wine not found. Please refresh the page and try again.');
                return;
            }

            console.log('Found wine:', wine);

            document.getElementById('editWineId').value = wine.id || '';
            document.getElementById('editWineName').value = wine.wineName || '';
            document.getElementById('editProducer').value = wine.producer || '';
            document.getElementById('editVintage').value = wine.vintage || '';
            document.getElementById('editWineType').value = wine.wineType || '';
            document.getElementById('editVarietal').value = wine.varietal || '';
            document.getElementById('editRegion').value = wine.region || '';
            document.getElementById('editSubRegion').value = wine.subRegion || '';
            document.getElementById('editCountry').value = wine.country || '';
            document.getElementById('editQuantity').value = wine.quantity || '';
            document.getElementById('editDrinkFrom').value = wine.drinkFrom || '';
            document.getElementById('editDrinkTo').value = wine.drinkTo || '';
            document.getElementById('editLocation').value = wine.location || '';
            document.getElementById('editCommunityScore').value = wine.communityScore || '';
            document.getElementById('editPersonalScore').value = wine.personalScore || '';
            document.getElementById('editCurrentValue').value = wine.currentValue || '';
            document.getElementById('editTastingNotes').value = wine.tastingNotes || '';
            document.getElementById('editPersonalNotes').value = wine.personalNotes || '';
            document.getElementById('editFoodPairings').value = wine.foodPairings || '';
            document.getElementById('editPhotoUrl').value = wine.photoUrl || '';

            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        function openCsvModal() {
            document.getElementById('csvModal').classList.add('active');
        }

        function closeCsvModal() {
            document.getElementById('csvModal').classList.remove('active');
            document.getElementById('csvData').value = '';
        }

        async function addWine() {
            const wine = {
                wineName: document.getElementById('addWineName').value,
                producer: document.getElementById('addProducer').value,
                vintage: document.getElementById('addVintage').value,
                type: document.getElementById('addWineType').value,
                varietal: document.getElementById('addVarietal').value,
                region: document.getElementById('addRegion').value,
                subRegion: document.getElementById('addSubRegion').value,
                country: document.getElementById('addCountry').value,
                quantity: document.getElementById('addQuantity').value,
                drinkWindowStart: document.getElementById('addDrinkFrom').value,
                drinkWindowEnd: document.getElementById('addDrinkTo').value,
                storageLocation: document.getElementById('addLocation').value,
                communityScore: document.getElementById('addCommunityScore').value,
                personalScore: document.getElementById('addPersonalScore').value,
                currentValue: document.getElementById('addCurrentValue').value,
                tastingNotes: document.getElementById('addTastingNotes').value,
                personalNotes: document.getElementById('addPersonalNotes').value,
                foodPairings: document.getElementById('addFoodPairings').value,
                photoUrl: document.getElementById('addPhotoUrl').value
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'add', wine: wine })
                });

                const data = await response.json();
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                alert('Wine added successfully!');
                closeAddModal();
                await loadWines();
            } catch (error) {
                alert('Error adding wine: ' + error.message);
            }
        }

        async function updateWine() {
            const wineId = document.getElementById('editWineId').value;
            const wine = {
                wineName: document.getElementById('editWineName').value,
                producer: document.getElementById('editProducer').value,
                vintage: document.getElementById('editVintage').value,
                type: document.getElementById('editWineType').value,
                varietal: document.getElementById('editVarietal').value,
                region: document.getElementById('editRegion').value,
                subRegion: document.getElementById('editSubRegion').value,
                country: document.getElementById('editCountry').value,
                quantity: document.getElementById('editQuantity').value,
                drinkWindowStart: document.getElementById('editDrinkFrom').value,
                drinkWindowEnd: document.getElementById('editDrinkTo').value,
                storageLocation: document.getElementById('editLocation').value,
                communityScore: document.getElementById('editCommunityScore').value,
                personalScore: document.getElementById('editPersonalScore').value,
                currentValue: document.getElementById('editCurrentValue').value,
                tastingNotes: document.getElementById('editTastingNotes').value,
                personalNotes: document.getElementById('editPersonalNotes').value,
                foodPairings: document.getElementById('editFoodPairings').value,
                photoUrl: document.getElementById('editPhotoUrl').value
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'update', id: wineId, wine: wine })
                });

                const data = await response.json();
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                alert('Wine updated successfully!');
                closeEditModal();
                await loadWines();
            } catch (error) {
                alert('Error updating wine: ' + error.message);
            }
        }

        async function deleteWine(wineId) {
            if (!confirm('Are you sure you want to delete this wine?')) return;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'delete', id: wineId })
                });

                const data = await response.json();
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                alert('Wine deleted successfully!');
                await loadWines();
            } catch (error) {
                alert('Error deleting wine: ' + error.message);
            }
        }

        function exportCsv() {
            const headers = ['wineName', 'producer', 'vintage', 'type', 'varietal', 'region', 'subRegion', 
                           'country', 'quantity', 'drinkWindowStart', 'drinkWindowEnd', 'storageLocation', 
                           'communityScore', 'personalScore', 'currentValue', 'tastingNotes', 
                           'personalNotes', 'foodPairings', 'photoUrl'];
            
            let csv = headers.join(',') + '\n';
            
            // Convert normalized wines back to Google Sheet format for export
            allWines.forEach(wine => {
                const row = [
                    wine.wineName,
                    wine.producer,
                    wine.vintage,
                    wine.wineType,
                    wine.varietal,
                    wine.region,
                    wine.subRegion,
                    wine.country,
                    wine.quantity,
                    wine.drinkFrom,
                    wine.drinkTo,
                    wine.location,
                    wine.communityScore,
                    wine.personalScore,
                    wine.currentValue,
                    wine.tastingNotes,
                    wine.personalNotes,
                    wine.foodPairings,
                    wine.photoUrl
                ].map(value => `"${String(value || '').replace(/"/g, '""')}"`);
                
                csv += row.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wine-cellar-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        async function importCsv() {
            const csvData = document.getElementById('csvData').value.trim();
            if (!csvData) {
                alert('Please paste CSV data');
                return;
            }

            try {
                const lines = csvData.split('\n').filter(line => line.trim());
                const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                
                const wines = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                    const wine = {};
                    
                    headers.forEach((header, index) => {
                        // Map CSV headers to Google Sheet field names
                        let fieldName = header;
                        if (header === 'wineType') fieldName = 'type';
                        if (header === 'drinkFrom') fieldName = 'drinkWindowStart';
                        if (header === 'drinkTo') fieldName = 'drinkWindowEnd';
                        if (header === 'location') fieldName = 'storageLocation';
                        
                        wine[fieldName] = values[index] || '';
                    });
                    
                    wines.push(wine);
                }
                
                let successCount = 0;
                for (const wine of wines) {
                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'add', wine: wine })
                        });
                        
                        const data = await response.json();
                        if (!data.error) successCount++;
                    } catch (err) {
                        console.error('Failed to import wine:', wine.wineName, err);
                    }
                }
                
                alert(`Successfully imported ${successCount} of ${wines.length} wines`);
                closeCsvModal();
                await loadWines();
                
            } catch (err) {
                alert(`Failed to parse CSV: ${err.message}`);
            }
        }
        
        // Make functions globally accessible for onclick handlers
        window.toggleExpand = toggleExpand;
        window.openEditModal = openEditModal;
        window.openAddModal = openAddModal;
        window.closeAddModal = closeAddModal;
        window.closeEditModal = closeEditModal;
        window.addWine = addWine;
        window.updateWine = updateWine;
        window.deleteWine = deleteWine;
        window.exportCsv = exportCsv;
        window.openCsvModal = openCsvModal;
        window.closeCsvModal = closeCsvModal;
        window.importCsv = importCsv;
        window.filterWines = filterWines;
        window.sortWines = sortWines;
        window.toggleTheme = toggleTheme;
    </script>

    <!-- AI Sommelier Chatbot FAB -->
    <button class="chat-fab" onclick="toggleChatPanel()" title="Ask your AI Sommelier">
        <span class="chat-fab-label">AI Sommelier</span>
        🍷
    </button>

    <!-- Chatbot Panel -->
    <div class="chat-panel" id="chatPanel">
        <div class="chat-panel-header">
            <div>
                <div class="chat-panel-title">🍷 AI Sommelier</div>
                <div class="chat-panel-subtitle">Powered by Claude · Knows your cellar</div>
            </div>
            <button class="chat-close-btn" onclick="toggleChatPanel()">×</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message assistant">
                <div class="chat-sender">Sommelier</div>
                <div class="chat-bubble">Bonjour! I'm your personal AI sommelier. I know every wine in your cellar and can search the wider wine world too. Ask me for a food pairing, a wine recommendation, or anything about wine!</div>
            </div>
        </div>
        <div class="chat-suggestions" id="chatSuggestions">
            <div class="chat-suggestion-chip" onclick="sendSuggestion('What wine should I open with a lamb roast?')">🥩 Lamb pairing</div>
            <div class="chat-suggestion-chip" onclick="sendSuggestion('What food goes well with my best red wines?')">🍽️ Food for reds</div>
            <div class="chat-suggestion-chip" onclick="sendSuggestion('Which of my wines should I open soonest?')">⏰ Drink soon</div>
            <div class="chat-suggestion-chip" onclick="sendSuggestion('Tell me about Bordeaux vintages')">📚 Wine knowledge</div>
        </div>
        <div class="chat-input-row">
            <textarea class="chat-input" id="chatInput" placeholder="Ask about food pairings, wine recommendations..." rows="1" onkeydown="handleChatKey(event)" oninput="autoResizeChat(this)"></textarea>
            <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">➤</button>
        </div>
    </div>

    <script>
        // ===== CHATBOT LOGIC =====
        let chatHistory = [];
        let chatOpen = false;

        function toggleChatPanel() {
            chatOpen = !chatOpen;
            document.getElementById('chatPanel').classList.toggle('open', chatOpen);
            if (chatOpen) {
                setTimeout(() => document.getElementById('chatInput').focus(), 300);
            }
        }

        function autoResizeChat(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 80) + 'px';
        }

        function handleChatKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        }

        function sendSuggestion(text) {
            document.getElementById('chatInput').value = text;
            sendChatMessage();
        }

        function buildCellarContext() {
            if (!allWines || allWines.length === 0) return "The cellar is currently empty or still loading.";
            const inStock = allWines.filter(w => parseInt(w.quantity) > 0);
            const lines = inStock.map(w => {
                const score = w.personalScore ? `Prof.Score:${w.personalScore}` : (w.communityScore ? `CommunityScore:${w.communityScore}*` : '');
                return `- ${w.wineName} (${w.producer}, ${w.vintage}, ${w.wineType}, ${w.region || ''}, ${w.country || ''}, Qty:${w.quantity}${score ? ', ' + score : ''}${w.drinkFrom ? ', DrinkFrom:'+w.drinkFrom : ''}${w.drinkTo ? '-'+w.drinkTo : ''}${w.foodPairings ? ', Pairings:'+w.foodPairings : ''})`;
            });
            return `Tracy's wine cellar currently has ${inStock.length} wines in stock:\n${lines.join('\n')}`;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const userText = input.value.trim();
            if (!userText) return;

            // Clear input
            input.value = '';
            input.style.height = 'auto';

            // Hide suggestions after first message
            document.getElementById('chatSuggestions').style.display = 'none';

            // Add user message to UI
            appendChatMessage('user', userText);

            // Add to history
            chatHistory.push({ role: 'user', content: userText });

            // Show thinking indicator
            const thinkingId = showThinking();

            // Disable send button
            const sendBtn = document.getElementById('chatSendBtn');
            sendBtn.disabled = true;

            try {
                const cellarContext = buildCellarContext();
                const systemPrompt = `You are an expert AI sommelier assistant for Tracy's personal wine cellar management app. You have deep knowledge of wines, regions, vintages, food pairings, and wine criticism.

${cellarContext}

Your role:
1. When asked about food pairings, recommend specific wines FROM TRACY'S CELLAR that pair well, citing the wine name, vintage, and why it pairs well
2. When asked what food goes with a wine, suggest food pairings based on the wine's profile
3. When asked general wine questions, answer with expertise
4. Reference professional scores (marked without *) and community scores (marked with *) when relevant
5. If no wines in the cellar match, say so and suggest what to look for when buying

Keep responses concise, warm, and expert. Use wine terminology naturally. Format wine names in bold when mentioning them. If recommending a wine, always mention how many bottles are left.`;

                // Call via Apps Script proxy (avoids CORS, keeps API key secure)
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'chat',
                        systemPrompt: systemPrompt,
                        messages: chatHistory.map(m => ({ role: m.role, content: m.content }))
                    })
                });

                const data = await response.json();
                removeThinking(thinkingId);

                if (data.error) {
                    appendChatMessage('assistant', `Sorry, I had trouble: ${data.error}. Please try again.`);
                } else if (data.reply) {
                    chatHistory.push({ role: 'assistant', content: data.reply });
                    appendChatMessage('assistant', data.reply);
                }

            } catch (err) {
                removeThinking(thinkingId);
                appendChatMessage('assistant', 'Sorry, I couldn\'t connect right now. Please try again in a moment.');
                console.error('Chat error:', err);
            }

            sendBtn.disabled = false;
        }

        function appendChatMessage(role, text) {
            const messages = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `chat-message ${role}`;

            // Convert basic markdown-like bold (**text**) to <strong>
            const formatted = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');

            div.innerHTML = `
                <div class="chat-sender">${role === 'user' ? 'You' : 'Sommelier'}</div>
                <div class="chat-bubble">${formatted}</div>
            `;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        function showThinking() {
            const messages = document.getElementById('chatMessages');
            const id = 'thinking-' + Date.now();
            const div = document.createElement('div');
            div.className = 'chat-message assistant';
            div.id = id;
            div.innerHTML = `
                <div class="chat-sender">Sommelier</div>
                <div class="chat-thinking">
                    <div class="chat-dot"></div>
                    <div class="chat-dot"></div>
                    <div class="chat-dot"></div>
                </div>
            `;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
            return id;
        }

        function removeThinking(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        window.toggleChatPanel = toggleChatPanel;
        window.sendChatMessage = sendChatMessage;
        window.sendSuggestion = sendSuggestion;
        window.handleChatKey = handleChatKey;
        window.autoResizeChat = autoResizeChat;
    </script>

</body>
</html>
