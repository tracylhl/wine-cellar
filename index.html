<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Wine Cellar</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        .header h1 { color: #1f2937; font-size: 28px; margin-bottom: 5px; }
        .header .stats { color: #6b7280; font-size: 14px; }
        .controls { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .controls input, .controls select { padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .controls input:focus, .controls select:focus { outline: none; border-color: #9333ea; }
        .btn { padding: 10px 20px; background: #9333ea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .btn:hover { background: #7e22ce; }
        .wine-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-top: 20px; }
        .wine-card { background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: box-shadow 0.2s; }
        .wine-card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.15); }
        .wine-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .wine-name { font-size: 18px; font-weight: 600; color: #1f2937; flex: 1; }
        .wine-producer { font-size: 14px; color: #6b7280; margin-top: 4px; }
        .wine-vintage { font-size: 24px; font-weight: 700; color: #1f2937; margin-left: 10px; }
        .wine-details { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; font-size: 14px; }
        .wine-details label { color: #6b7280; }
        .wine-details value { font-weight: 500; color: #1f2937; }
        .wine-status { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-unknown { background: #e5e7eb; color: #374151; }
        .status-young { background: #dbeafe; color: #1e40af; }
        .status-ready { background: #d1fae5; color: #065f46; }
        .status-peak { background: #fecaca; color: #991b1b; }
        .wine-score { font-size: 18px; font-weight: 700; color: #9333ea; }
        .wine-quantity { background: #f9fafb; padding: 10px; border-radius: 6px; margin-bottom: 12px; display: flex; justify-content: space-between; font-size: 14px; }
        .wine-quantity strong { font-size: 18px; margin-left: 8px; }
        .wine-actions { display: flex; gap: 8px; }
        .wine-actions button { flex: 1; padding: 8px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; }
        .btn-more { background: #f3f4f6; color: #374151; }
        .btn-more:hover { background: #e5e7eb; }
        .btn-drink { background: #9333ea; color: white; }
        .btn-drink:hover { background: #7e22ce; }
        .btn-edit { background: #3b82f6; color: white; }
        .btn-edit:hover { background: #2563eb; }
        .btn-delete { background: #ef4444; color: white; }
        .btn-delete:hover { background: #dc2626; }
        .expanded-details { margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; font-size: 13px; }
        .expanded-details .detail-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 8px; }
        .expanded-details label { color: #6b7280; }
        .expanded-details value { font-weight: 500; color: #1f2937; }
        .loading { text-align: center; padding: 60px 20px; }
        .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #9333ea; border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error { background: white; border-radius: 8px; padding: 30px; max-width: 500px; margin: 40px auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .error h2 { color: #dc2626; margin-bottom: 15px; }
        .error-details { background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; padding: 15px; margin: 15px 0; font-size: 13px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 8px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 20px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; color: #374151; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .form-group textarea { resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn-secondary { background: #f3f4f6; color: #374151; padding: 10px 20px; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; }
        .btn-secondary:hover { background: #e5e7eb; }
        @media (max-width: 768px) {
            .controls { grid-template-columns: 1fr; }
            .wine-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading your wine cellar...</p>
        </div>
    </div>

    <!-- Add Wine Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Wine</h2>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>
            <form id="addForm" onsubmit="handleAddWine(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Wine Name *</label>
                        <input type="text" name="wineName" required>
                    </div>
                    <div class="form-group">
                        <label>Producer *</label>
                        <input type="text" name="producer" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Vintage</label>
                        <input type="number" name="vintage">
                    </div>
                    <div class="form-group">
                        <label>Varietal</label>
                        <input type="text" name="varietal">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select name="type">
                            <option value="Red">Red</option>
                            <option value="White">White</option>
                            <option value="Ros√©">Ros√©</option>
                            <option value="Sparkling">Sparkling</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" name="quantity" value="1" min="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Country</label>
                        <input type="text" name="country">
                    </div>
                    <div class="form-group">
                        <label>Region</label>
                        <input type="text" name="region">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Drink Window Start</label>
                        <input type="number" name="drinkWindowStart" placeholder="e.g., 2025">
                    </div>
                    <div class="form-group">
                        <label>Drink Window End</label>
                        <input type="number" name="drinkWindowEnd" placeholder="e.g., 2035">
                    </div>
                </div>
                <div class="form-group">
                    <label>Personal Notes</label>
                    <textarea name="personalNotes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeAddModal()">Cancel</button>
                    <button type="submit" class="btn">Add Wine</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzzwhBtsTYoT04KPGy6QGur4BfsDAQjjRdL5DInfFLTLnbOT5SKrSf4w3W8jFCPfJ-kvQ/exec';
        
        let wines = [];
        let filteredWines = [];
        let searchTerm = '';
        let filterType = 'all';
        let sortBy = 'name';
        let expandedWineId = null;

        // Load wines on page load
        window.onload = () => {
            loadWines();
        };

        async function loadWines() {
            try {
                const response = await fetch(`${API_URL}?action=getAll`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                wines = data.wines || [];
                filterAndSortWines();
                renderApp();
            } catch (err) {
                renderError(err.message);
            }
        }

        function filterAndSortWines() {
            filtered = wines.filter(wine => {
                const matchesSearch = !searchTerm || 
                    wine.wineName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    wine.producer?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    wine.vintage?.toString().includes(searchTerm) ||
                    wine.varietal?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    wine.region?.toLowerCase().includes(searchTerm.toLowerCase());
                
                const matchesType = filterType === 'all' || wine.type?.toLowerCase() === filterType;
                
                return matchesSearch && matchesType;
            });

            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'name':
                        return (a.wineName || '').localeCompare(b.wineName || '');
                    case 'vintage':
                        return (b.vintage || 0) - (a.vintage || 0);
                    case 'score':
                        return (parseFloat(b.communityScore) || 0) - (parseFloat(a.communityScore) || 0);
                    case 'quantity':
                        return (parseInt(b.quantity) || 0) - (parseInt(a.quantity) || 0);
                    default:
                        return 0;
                }
            });

            filteredWines = filtered;
        }

        function getDrinkingStatus(wine) {
            const currentYear = new Date().getFullYear();
            const start = parseInt(wine.drinkWindowStart);
            const end = parseInt(wine.drinkWindowEnd);

            if (!start || !end || start === 9999 || end === 9999) {
                return { status: 'unknown', label: 'Unknown', className: 'status-unknown' };
            }

            if (currentYear < start) {
                return { status: 'young', label: 'Too Young', className: 'status-young' };
            } else if (currentYear >= start && currentYear <= end) {
                return { status: 'ready', label: 'Ready to Drink', className: 'status-ready' };
            } else {
                return { status: 'peak', label: 'Past Peak', className: 'status-peak' };
            }
        }

        function formatScore(score) {
            if (!score) return '-';
            const num = parseFloat(score);
            return isNaN(num) ? '-' : num.toFixed(1);
        }

        function renderApp() {
            const totalBottles = wines.reduce((sum, w) => sum + (parseInt(w.quantity) || 0), 0);
            
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <h1>üç∑ My Wine Cellar</h1>
                    <div class="stats">${filteredWines.length} wines ‚Ä¢ ${totalBottles} bottles</div>
                    <div class="controls">
                        <input type="text" placeholder="Search wines..." oninput="handleSearch(this.value)">
                        <select onchange="handleFilterType(this.value)">
                            <option value="all">All Types</option>
                            <option value="red">Red</option>
                            <option value="white">White</option>
                        </select>
                        <select onchange="handleSort(this.value)">
                            <option value="name">Sort by Name</option>
                            <option value="vintage">Sort by Vintage</option>
                            <option value="score">Sort by Score</option>
                            <option value="quantity">Sort by Quantity</option>
                        </select>
                    </div>
                    <button class="btn" style="margin-top: 15px;" onclick="openAddModal()">+ Add Wine</button>
                </div>
                <div class="wine-grid">
                    ${filteredWines.map(wine => renderWineCard(wine)).join('')}
                </div>
            `;
        }

        function renderWineCard(wine) {
            const status = getDrinkingStatus(wine);
            const isExpanded = expandedWineId === wine.id;
            
            return `
                <div class="wine-card">
                    <div class="wine-header">
                        <div style="flex: 1;">
                            <div class="wine-name">${wine.wineName || 'Unnamed Wine'}</div>
                            <div class="wine-producer">${wine.producer || ''}</div>
                        </div>
                        <div class="wine-vintage">${wine.vintage || '-'}</div>
                    </div>
                    
                    <div class="wine-details">
                        <div><label>Varietal:</label><br><value>${wine.varietal || '-'}</value></div>
                        <div><label>Region:</label><br><value>${wine.region || '-'}</value></div>
                    </div>
                    
                    <div class="wine-status">
                        <span class="status-badge ${status.className}">${status.label}</span>
                        ${wine.communityScore ? `<span class="wine-score">${formatScore(wine.communityScore)}</span>` : ''}
                    </div>
                    
                    <div class="wine-quantity">
                        <span>In Cellar:<strong>${wine.quantity || 0}</strong></span>
                        ${parseInt(wine.quantityConsumed) > 0 ? `<span>Consumed:<strong>${wine.quantityConsumed}</strong></span>` : ''}
                    </div>
                    
                    ${isExpanded ? renderExpandedDetails(wine) : ''}
                    
                    <div class="wine-actions">
                        <button class="btn-more" onclick="toggleExpand(${wine.id})">${isExpanded ? '‚ñ≤ Less' : '‚ñº More'}</button>
                        ${parseInt(wine.quantity) > 0 ? `<button class="btn-drink" onclick="consumeBottle(${wine.id})">Drink</button>` : ''}
                        <button class="btn-delete" onclick="deleteWine(${wine.id})">Delete</button>
                    </div>
                </div>
            `;
        }

        function renderExpandedDetails(wine) {
            return `
                <div class="expanded-details">
                    <div class="detail-row">
                        ${wine.appellation ? `<div><label>Appellation:</label><br><value>${wine.appellation}</value></div>` : ''}
                        ${wine.designation && wine.designation !== 'Unknown' ? `<div><label>Designation:</label><br><value>${wine.designation}</value></div>` : ''}
                    </div>
                    ${wine.drinkWindowStart && wine.drinkWindowStart !== '9999' ? `
                        <div class="detail-row">
                            <div><label>Drinking Window:</label><br><value>${wine.drinkWindowStart} - ${wine.drinkWindowEnd}</value></div>
                        </div>
                    ` : ''}
                    ${wine.currentValue ? `
                        <div class="detail-row">
                            <div><label>Current Value:</label><br><value>SGD ${parseFloat(wine.currentValue).toFixed(2)}</value></div>
                        </div>
                    ` : ''}
                    ${wine.personalNotes ? `
                        <div style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-top: 8px;">
                            <label style="font-weight: 600;">Personal Notes:</label><br>
                            <div style="margin-top: 4px;">${wine.personalNotes}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderError(message) {
            document.getElementById('app').innerHTML = `
                <div class="error">
                    <h2>‚ö†Ô∏è Connection Error</h2>
                    <p>${message}</p>
                    <div class="error-details">
                        <strong>Checklist:</strong><br>
                        ‚Ä¢ Apps Script has CORS headers<br>
                        ‚Ä¢ Deployment "Who has access" = "Anyone"<br>
                        ‚Ä¢ Sheet tab named "WineCellar"<br>
                        ‚Ä¢ Data imported (29 wines)
                    </div>
                    <button class="btn" onclick="loadWines()">Retry Connection</button>
                </div>
            `;
        }

        function handleSearch(value) {
            searchTerm = value;
            filterAndSortWines();
            renderApp();
        }

        function handleFilterType(value) {
            filterType = value;
            filterAndSortWines();
            renderApp();
        }

        function handleSort(value) {
            sortBy = value;
            filterAndSortWines();
            renderApp();
        }

        function toggleExpand(id) {
            expandedWineId = expandedWineId === id ? null : id;
            renderApp();
        }

        async function consumeBottle(id) {
            if (!confirm('Mark one bottle as consumed?')) return;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'consume', id: id })
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                await loadWines();
            } catch (err) {
                alert(`Failed to consume bottle: ${err.message}`);
            }
        }

        async function deleteWine(id) {
            if (!confirm('Are you sure you want to delete this wine?')) return;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'delete', id: id })
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                await loadWines();
            } catch (err) {
                alert(`Failed to delete wine: ${err.message}`);
            }
        }

        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            document.getElementById('addForm').reset();
        }

        async function handleAddWine(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const wineData = {};
            formData.forEach((value, key) => {
                wineData[key] = value;
            });
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'add', wine: wineData })
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                closeAddModal();
                await loadWines();
            } catch (err) {
                alert(`Failed to add wine: ${err.message}`);
            }
        }
    </script>
</body>
</html>
