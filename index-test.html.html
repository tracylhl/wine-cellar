<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Wine Cellar</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Lato:wght@300;400;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Vintage Classy Color Palette */
        :root {
            --bg-primary: #1a1614;
            --bg-secondary: #2d2520;
            --card-bg: #2a2320;
            --card-border: #4a3f38;
            --text-primary: #f5f1ed;
            --text-secondary: #c9bfb5;
            --text-muted: #9a8f85;
            --accent-primary: #b8926a;
            --accent-dark: #8b6f47;
            --accent-light: #d4b895;
            --burgundy: #6b2d3c;
            --burgundy-light: #8b3d4d;
            --border: #3d3430;
            --shadow: rgba(0, 0, 0, 0.4);
        }
        
        body { 
            font-family: 'Lato', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh; 
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        h1, h2, h3, h4 {
            font-family: 'Cormorant Garamond', serif;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .header { 
            background: var(--card-bg); 
            box-shadow: 0 4px 16px var(--shadow); 
            padding: 32px 36px; 
            margin-bottom: 28px; 
            border-radius: 2px;
            border: 1px solid var(--card-border);
        }
        
        .header h1 { 
            color: var(--accent-light); 
            font-size: 42px; 
            margin-bottom: 8px; 
            font-weight: 600;
            letter-spacing: 1px;
            font-family: 'Cormorant Garamond', serif;
        }
        
        .header .stats { 
            color: var(--text-secondary); 
            font-size: 15px; 
            margin-bottom: 20px;
            font-weight: 300;
            letter-spacing: 0.5px;
        }
        
        .header-actions {
            display: flex;
            gap: 14px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .controls-wrapper {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 16px;
            margin-top: 20px;
        }
        
        .controls { 
            display: grid; 
            grid-template-columns: 2fr 1fr 1fr; 
            gap: 14px; 
        }
        
        .controls input, .controls select { 
            padding: 12px 16px; 
            border: 1px solid var(--border); 
            border-radius: 2px; 
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            font-family: 'Lato', sans-serif;
        }
        
        .controls input:focus, .controls select:focus { 
            outline: none; 
            border-color: var(--accent-primary);
            background: var(--card-bg);
            box-shadow: 0 0 0 3px rgba(184, 146, 106, 0.15);
        }
        
        .controls input::placeholder {
            color: var(--text-muted);
        }
        
        .filter-toggle {
            padding: 12px 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 2px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 400;
            transition: all 0.3s ease;
            white-space: nowrap;
            letter-spacing: 0.5px;
        }
        
        .filter-toggle:hover {
            background: var(--card-bg);
            border-color: var(--accent-primary);
            color: var(--accent-light);
        }
        
        .filter-panel {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 2px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px var(--shadow);
            display: none;
        }
        
        .filter-panel.active {
            display: block;
        }
        
        .filter-panel h3 {
            font-size: 18px;
            margin-bottom: 16px;
            color: var(--accent-light);
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .filter-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 14px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-secondary);
            transition: color 0.2s;
        }
        
        .checkbox-label:hover {
            color: var(--text-primary);
        }
        
        .checkbox-label input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 18px;
            height: 18px;
            accent-color: var(--accent-primary);
        }
        
        .btn { 
            padding: 12px 28px; 
            background: var(--accent-primary); 
            color: var(--bg-primary); 
            border: none; 
            border-radius: 2px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600;
            transition: all 0.3s ease;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            font-family: 'Lato', sans-serif;
        }
        
        .btn:hover { 
            background: var(--accent-light);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(184, 146, 106, 0.4);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--accent-light);
            border: 1px solid var(--accent-primary);
        }
        
        .btn-outline:hover {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }
        
        .wine-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); 
            gap: 24px; 
        }
        
        .wine-card { 
            background: var(--card-bg); 
            border-radius: 2px; 
            padding: 24px; 
            box-shadow: 0 4px 12px var(--shadow);
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }
        
        .wine-card:hover { 
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
            transform: translateY(-3px);
            border-color: var(--accent-dark);
        }
        
        .wine-photo {
            width: 100%;
            height: 220px;
            object-fit: cover;
            border-radius: 2px;
            margin-bottom: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
        }
        
        .wine-header { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 16px; 
            align-items: flex-start;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }
        
        .wine-name { 
            font-size: 22px; 
            font-weight: 600; 
            color: var(--accent-light); 
            flex: 1;
            line-height: 1.3;
            font-family: 'Cormorant Garamond', serif;
            letter-spacing: 0.3px;
        }
        
        .wine-producer { 
            font-size: 15px; 
            color: var(--text-secondary); 
            margin-top: 6px;
            font-weight: 400;
            font-style: italic;
        }
        
        .wine-vintage { 
            font-size: 32px; 
            font-weight: 700; 
            color: var(--accent-primary); 
            margin-left: 20px;
            line-height: 1;
            font-family: 'Cormorant Garamond', serif;
        }
        
        .wine-details { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 14px; 
            margin-bottom: 16px; 
            font-size: 13px; 
        }
        
        .wine-details label { 
            color: var(--text-muted); 
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }
        
        .wine-details value { 
            font-weight: 400; 
            color: var(--text-primary);
            display: block;
            margin-top: 4px;
        }
        
        .wine-tasting-preview {
            background: rgba(107, 45, 60, 0.2);
            border-left: 2px solid var(--burgundy);
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 2px;
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
            font-style: italic;
            min-height: 60px;
        }
        
        .wine-tasting-preview.empty {
            color: var(--text-muted);
            font-style: normal;
        }
        
        .wine-status { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px; 
        }
        
        .status-badge { 
            padding: 6px 16px; 
            border-radius: 2px; 
            font-size: 11px; 
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .status-unknown { background: rgba(154, 143, 133, 0.3); color: var(--text-muted); border: 1px solid var(--text-muted); }
        .status-young { background: rgba(100, 149, 237, 0.2); color: #89b4f8; border: 1px solid #6495ed; }
        .status-ready { background: rgba(107, 45, 60, 0.3); color: #d4b895; border: 1px solid var(--burgundy); }
        .status-peak { background: rgba(139, 61, 77, 0.3); color: #c9858f; border: 1px solid var(--burgundy-light); }
        
        .wine-score { 
            font-size: 20px; 
            font-weight: 700; 
            color: var(--accent-light);
            font-family: 'Cormorant Garamond', serif;
        }
        
        .wine-quantity { 
            background: rgba(61, 52, 48, 0.5); 
            padding: 14px; 
            border-radius: 2px; 
            margin-bottom: 16px; 
            display: flex; 
            justify-content: space-between; 
            font-size: 14px;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .wine-quantity strong { 
            font-size: 20px; 
            margin-left: 8px;
            color: var(--accent-light);
            font-weight: 700;
        }
        
        .food-pairings {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .food-tag {
            background: rgba(184, 146, 106, 0.15);
            color: var(--accent-light);
            border: 1px solid rgba(184, 146, 106, 0.3);
            padding: 5px 12px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .wine-actions { 
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px; 
        }
        
        .wine-actions button { 
            padding: 11px 8px; 
            border: 1px solid var(--border); 
            border-radius: 2px; 
            cursor: pointer; 
            font-size: 12px; 
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-more { 
            background: var(--bg-secondary); 
            color: var(--text-primary);
        }
        
        .btn-more:hover { 
            background: var(--card-border);
            border-color: var(--accent-dark);
        }
        
        .btn-drink { 
            background: var(--burgundy); 
            color: var(--text-primary);
            border-color: var(--burgundy);
        }
        
        .btn-drink:hover { 
            background: var(--burgundy-light);
            border-color: var(--burgundy-light);
        }
        
        .btn-edit { 
            background: transparent;
            color: var(--accent-primary);
            border-color: var(--accent-dark);
        }
        
        .btn-edit:hover { 
            background: var(--accent-dark);
            color: var(--text-primary);
        }
        
        .btn-delete { 
            background: transparent;
            color: #c9858f;
            border-color: #8b3d4d;
        }
        
        .btn-delete:hover { 
            background: #8b3d4d;
            color: var(--text-primary);
            border-color: #8b3d4d;
        }
        
        .expanded-details { 
            margin-top: 20px; 
            padding-top: 20px; 
            border-top: 1px solid var(--border); 
            font-size: 13px; 
        }
        
        .expanded-details .detail-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 14px; 
            margin-bottom: 14px; 
        }
        
        .expanded-details label { 
            color: var(--text-muted);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }
        
        .expanded-details value { 
            font-weight: 400; 
            color: var(--text-primary);
            display: block;
            margin-top: 4px;
        }
        
        .notes-box {
            background: rgba(107, 45, 60, 0.2);
            padding: 16px;
            border-radius: 2px;
            margin-top: 14px;
            border-left: 3px solid var(--burgundy);
        }
        
        .notes-box label {
            font-weight: 600;
            color: var(--accent-light);
            display: block;
            margin-bottom: 8px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        
        .notes-box div {
            color: var(--text-secondary);
            line-height: 1.7;
            font-style: italic;
        }
        
        .loading { 
            text-align: center; 
            padding: 100px 20px; 
        }
        
        .spinner { 
            border: 4px solid var(--border); 
            border-top: 4px solid var(--accent-primary); 
            border-radius: 50%; 
            width: 56px; 
            height: 56px; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 24px; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .error { 
            background: var(--card-bg); 
            border-radius: 2px; 
            padding: 40px; 
            max-width: 500px; 
            margin: 80px auto; 
            box-shadow: 0 8px 24px var(--shadow);
            border: 1px solid var(--card-border);
        }
        
        .error h2 { 
            color: #c9858f; 
            margin-bottom: 20px;
            font-family: 'Cormorant Garamond', serif;
        }
        
        .error-details { 
            background: rgba(139, 61, 77, 0.2); 
            border: 1px solid var(--burgundy); 
            border-radius: 2px; 
            padding: 18px; 
            margin: 20px 0; 
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.85); 
            z-index: 1000;
            backdrop-filter: blur(6px);
        }
        
        .modal.active { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        
        .modal-content { 
            background: var(--card-bg); 
            border-radius: 2px; 
            padding: 32px; 
            max-width: 750px; 
            width: 90%; 
            max-height: 90vh; 
            overflow-y: auto;
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.8);
            border: 1px solid var(--card-border);
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 28px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-header h2 { 
            font-size: 26px;
            color: var(--accent-light);
            font-weight: 600;
            font-family: 'Cormorant Garamond', serif;
            letter-spacing: 0.5px;
        }
        
        .modal-close { 
            background: none; 
            border: none; 
            font-size: 32px; 
            cursor: pointer; 
            color: var(--text-muted);
            transition: color 0.3s;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: var(--accent-light);
        }
        
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-size: 12px; 
            font-weight: 600; 
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        
        .form-group input, 
        .form-group select, 
        .form-group textarea { 
            width: 100%; 
            padding: 12px 16px; 
            border: 1px solid var(--border); 
            border-radius: 2px; 
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            font-family: 'Lato', sans-serif;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: var(--card-bg);
            box-shadow: 0 0 0 3px rgba(184, 146, 106, 0.15);
        }
        
        .form-group textarea { 
            resize: vertical;
            min-height: 90px;
            line-height: 1.6;
        }
        
        .form-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 18px; 
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 10px;
        }
        
        .form-actions { 
            display: flex; 
            gap: 14px; 
            justify-content: flex-end; 
            margin-top: 28px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }
        
        .btn-secondary { 
            background: var(--bg-secondary); 
            color: var(--text-primary); 
            padding: 12px 28px; 
            border: 1px solid var(--border); 
            border-radius: 2px; 
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-size: 14px;
        }
        
        .btn-secondary:hover { 
            background: var(--card-border);
            border-color: var(--accent-dark);
        }
        
        .csv-instructions {
            background: rgba(107, 45, 60, 0.2);
            padding: 18px;
            border-radius: 2px;
            margin-bottom: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            border-left: 3px solid var(--burgundy);
            line-height: 1.6;
        }
        
        .csv-instructions strong {
            color: var(--accent-light);
            display: block;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }
        
        @media (max-width: 968px) {
            .controls-wrapper {
                grid-template-columns: 1fr;
            }
            
            .controls { 
                grid-template-columns: 1fr 1fr; 
            }
            
            .wine-grid { 
                grid-template-columns: 1fr; 
            }
            
            .form-row { 
                grid-template-columns: 1fr; 
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .wine-actions {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 640px) {
            .header h1 {
                font-size: 32px;
            }
            
            .header-actions {
                flex-direction: column;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .expanded-details .detail-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="loading">
            <div class="spinner"></div>
            <p style="color: var(--text-secondary); letter-spacing: 0.5px;">Loading your wine cellar...</p>
        </div>
    </div>

    <!-- Add Wine Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Wine</h2>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>
            <form id="addForm" onsubmit="handleAddWine(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Wine Name *</label>
                        <input type="text" name="wineName" required>
                    </div>
                    <div class="form-group">
                        <label>Producer *</label>
                        <input type="text" name="producer" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Vintage</label>
                        <input type="number" name="vintage">
                    </div>
                    <div class="form-group">
                        <label>Varietal</label>
                        <input type="text" name="varietal">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select name="type">
                            <option value="Red">Red</option>
                            <option value="White">White</option>
                            <option value="Rosé">Rosé</option>
                            <option value="Sparkling">Sparkling</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" name="quantity" value="1" min="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Country</label>
                        <input type="text" name="country">
                    </div>
                    <div class="form-group">
                        <label>Region</label>
                        <input type="text" name="region">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Sub-Region</label>
                        <input type="text" name="subRegion" placeholder="e.g., Serralunga d'Alba">
                    </div>
                    <div class="form-group">
                        <label>Appellation</label>
                        <input type="text" name="appellation" placeholder="e.g., Barolo DOCG">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Drink Window Start</label>
                        <input type="number" name="drinkWindowStart" placeholder="e.g., 2025">
                    </div>
                    <div class="form-group">
                        <label>Drink Window End</label>
                        <input type="number" name="drinkWindowEnd" placeholder="e.g., 2035">
                    </div>
                </div>
                <div class="form-group">
                    <label>Storage Location</label>
                    <input type="text" name="storageLocation" placeholder="e.g., Rack A, Shelf 3">
                </div>
                <div class="form-group">
                    <label>Photo URL</label>
                    <input type="url" name="photoUrl" placeholder="https://example.com/wine-photo.jpg">
                </div>
                <div class="form-group">
                    <label>Food Pairings</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="foodPairing" value="Beef"> Beef
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="foodPairing" value="Lamb"> Lamb
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="foodPairing" value="Pork"> Pork
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="foodPairing" value="Poultry"> Poultry
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="foodPairing" value="Seafood"> Seafood
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="foodPairing" value="Pasta"> Pasta
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="foodPairing" value="Cheese"> Cheese
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="foodPairing" value="Dessert"> Dessert
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Tasting Notes</label>
                    <textarea name="tastingNotes" rows="3" placeholder="Describe the flavor profile..."></textarea>
                </div>
                <div class="form-group">
                    <label>Personal Notes</label>
                    <textarea name="personalNotes" rows="3" placeholder="Your thoughts and memories..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeAddModal()">Cancel</button>
                    <button type="submit" class="btn">Add Wine</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Wine Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Wine</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editForm" onsubmit="handleEditWine(event)">
                <input type="hidden" name="id" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Wine Name *</label>
                        <input type="text" name="wineName" id="editWineName" required>
                    </div>
                    <div class="form-group">
                        <label>Producer *</label>
                        <input type="text" name="producer" id="editProducer" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Vintage</label>
                        <input type="number" name="vintage" id="editVintage">
                    </div>
                    <div class="form-group">
                        <label>Varietal</label>
                        <input type="text" name="varietal" id="editVarietal">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select name="type" id="editType">
                            <option value="Red">Red</option>
                            <option value="White">White</option>
                            <option value="Rosé">Rosé</option>
                            <option value="Sparkling">Sparkling</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" name="quantity" id="editQuantity" min="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Country</label>
                        <input type="text" name="country" id="editCountry">
                    </div>
                    <div class="form-group">
                        <label>Region</label>
                        <input type="text" name="region" id="editRegion">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Sub-Region</label>
                        <input type="text" name="subRegion" id="editSubRegion">
                    </div>
                    <div class="form-group">
                        <label>Appellation</label>
                        <input type="text" name="appellation" id="editAppellation">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Drink Window Start</label>
                        <input type="number" name="drinkWindowStart" id="editDrinkStart">
                    </div>
                    <div class="form-group">
                        <label>Drink Window End</label>
                        <input type="number" name="drinkWindowEnd" id="editDrinkEnd">
                    </div>
                </div>
                <div class="form-group">
                    <label>Storage Location</label>
                    <input type="text" name="storageLocation" id="editStorageLocation">
                </div>
                <div class="form-group">
                    <label>Photo URL</label>
                    <input type="url" name="photoUrl" id="editPhotoUrl">
                </div>
                <div class="form-group">
                    <label>Food Pairings</label>
                    <div class="checkbox-group" id="editFoodPairings">
                        <label class="checkbox-label">
                            <input type="checkbox" name="foodPairing" value="Beef"> Beef
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="foodPairing" value="Lamb"> Lamb
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="foodPairing" value="Pork"> Pork
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="foodPairing" value="Poultry"> Poultry
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="foodPairing" value="Seafood"> Seafood
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="foodPairing" value="Pasta"> Pasta
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="foodPairing" value="Cheese"> Cheese
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="foodPairing" value="Dessert"> Dessert
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Tasting Notes</label>
                    <textarea name="tastingNotes" id="editTastingNotes" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Personal Notes</label>
                    <textarea name="personalNotes" id="editPersonalNotes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn">Update Wine</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CSV Import Modal -->
    <div id="csvModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import Wines from CSV</h2>
                <button class="modal-close" onclick="closeCsvModal()">&times;</button>
            </div>
            <div class="csv-instructions">
                <strong>CSV Format:</strong>
                Paste CSV data with columns: wineName, producer, vintage, varietal, type, quantity, country, region, subRegion, appellation, drinkWindowStart, drinkWindowEnd, communityScore, storageLocation, photoUrl, foodPairings (comma-separated), tastingNotes, personalNotes
            </div>
            <div class="form-group">
                <label>CSV Data</label>
                <textarea id="csvInput" rows="15" placeholder="Paste your CSV data here..." style="font-family: 'Courier New', monospace;"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="closeCsvModal()">Cancel</button>
                <button type="button" class="btn" onclick="handleCsvImport()">Import Wines</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzzwhBtsTYoT04KPGy6QGur4BfsDAQjjRdL5DInfFLTLnbOT5SKrSf4w3W8jFCPfJ-kvQ/exec';
        
        let wines = [];
        let filteredWines = [];
        let searchTerm = '';
        let filterType = 'all';
        let sortBy = 'name';
        let expandedWineId = null;
        let selectedFoodPairings = [];
        let showFilters = false;

        window.onload = () => {
            loadWines();
        };

        async function loadWines() {
            try {
                const response = await fetch(`${API_URL}?action=getAll`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                wines = data.wines || [];
                filterAndSortWines();
                renderApp();
            } catch (err) {
                renderError(err.message);
            }
        }

        function filterAndSortWines() {
            filtered = wines.filter(wine => {
                const matchesSearch = !searchTerm || 
                    wine.wineName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    wine.producer?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    wine.vintage?.toString().includes(searchTerm) ||
                    wine.varietal?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    wine.region?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    wine.subRegion?.toLowerCase().includes(searchTerm.toLowerCase());
                
                const matchesType = filterType === 'all' || wine.type?.toLowerCase() === filterType;
                
                const matchesFood = selectedFoodPairings.length === 0 || 
                    selectedFoodPairings.some(food => 
                        wine.foodPairings?.toLowerCase().includes(food.toLowerCase())
                    );
                
                return matchesSearch && matchesType && matchesFood;
            });

            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'name':
                        return (a.wineName || '').localeCompare(b.wineName || '');
                    case 'vintage':
                        return (b.vintage || 0) - (a.vintage || 0);
                    case 'score':
                        return (parseFloat(b.communityScore) || 0) - (parseFloat(a.communityScore) || 0);
                    case 'quantity':
                        return (parseInt(b.quantity) || 0) - (parseInt(a.quantity) || 0);
                    case 'drinkdate':
                        const aStart = parseInt(a.drinkWindowStart) || 9999;
                        const bStart = parseInt(b.drinkWindowStart) || 9999;
                        return aStart - bStart;
                    default:
                        return 0;
                }
            });

            filteredWines = filtered;
        }

        function getDrinkingStatus(wine) {
            const currentYear = new Date().getFullYear();
            const start = parseInt(wine.drinkWindowStart);
            const end = parseInt(wine.drinkWindowEnd);

            if (!start || !end || start === 9999 || end === 9999) {
                return { status: 'unknown', label: 'Unknown', className: 'status-unknown' };
            }

            if (currentYear < start) {
                return { status: 'young', label: 'Too Young', className: 'status-young' };
            } else if (currentYear >= start && currentYear <= end) {
                return { status: 'ready', label: 'Ready', className: 'status-ready' };
            } else {
                return { status: 'peak', label: 'Past Peak', className: 'status-peak' };
            }
        }

        function formatScore(score) {
            if (!score) return '-';
            const num = parseFloat(score);
            return isNaN(num) ? '-' : num.toFixed(1);
        }

        function renderApp() {
            const totalBottles = wines.reduce((sum, w) => sum + (parseInt(w.quantity) || 0), 0);
            
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <h1>Wine Cellar</h1>
                    <div class="stats">${filteredWines.length} wines • ${totalBottles} bottles</div>
                    
                    <div class="header-actions">
                        <button class="btn" onclick="openAddModal()">Add Wine</button>
                        <button class="btn-outline btn" onclick="openCsvModal()">Import CSV</button>
                    </div>
                    
                    <div class="controls-wrapper">
                        <div class="controls">
                            <input type="text" placeholder="Search wines..." value="${searchTerm}" oninput="handleSearch(this.value)">
                            <select value="${filterType}" onchange="handleFilterType(this.value)">
                                <option value="all">All Types</option>
                                <option value="red">Red</option>
                                <option value="white">White</option>
                                <option value="rosé">Rosé</option>
                                <option value="sparkling">Sparkling</option>
                            </select>
                            <select value="${sortBy}" onchange="handleSort(this.value)">
                                <option value="name">Sort by Name</option>
                                <option value="vintage">Sort by Vintage</option>
                                <option value="score">Sort by Score</option>
                                <option value="quantity">Sort by Quantity</option>
                                <option value="drinkdate">Sort by Drink Date</option>
                            </select>
                        </div>
                        <button class="filter-toggle" onclick="toggleFilters()">
                            ${showFilters ? 'Close' : 'Food Pairings'}
                        </button>
                    </div>
                </div>
                
                ${showFilters ? renderFoodFilters() : ''}
                
                <div class="wine-grid">
                    ${filteredWines.length > 0 ? filteredWines.map(wine => renderWineCard(wine)).join('') : '<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary); padding: 60px; font-size: 16px; letter-spacing: 0.5px;">No wines found</p>'}
                </div>
            `;
        }

        function renderFoodFilters() {
            const foods = ['Beef', 'Lamb', 'Pork', 'Poultry', 'Seafood', 'Pasta', 'Cheese', 'Dessert'];
            return `
                <div class="filter-panel active">
                    <h3>Filter by Food Pairing</h3>
                    <div class="filter-checkboxes">
                        ${foods.map(food => `
                            <label class="checkbox-label">
                                <input type="checkbox" 
                                    value="${food}" 
                                    ${selectedFoodPairings.includes(food) ? 'checked' : ''}
                                    onchange="handleFoodFilter('${food}', this.checked)">
                                ${food}
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderWineCard(wine) {
            const status = getDrinkingStatus(wine);
            const isExpanded = expandedWineId === wine.id;
            const foodPairings = wine.foodPairings ? wine.foodPairings.split(',').map(f => f.trim()) : [];
            
            return `
                <div class="wine-card">
                    ${wine.photoUrl ? `<img src="${wine.photoUrl}" alt="${wine.wineName}" class="wine-photo" onerror="this.style.display='none'">` : ''}
                    
                    <div class="wine-header">
                        <div style="flex: 1;">
                            <div class="wine-name">${wine.wineName || 'Unnamed Wine'}</div>
                            <div class="wine-producer">${wine.producer || ''}</div>
                        </div>
                        <div class="wine-vintage">${wine.vintage || '-'}</div>
                    </div>
                    
                    <div class="wine-details">
                        <div><label>Varietal</label><value>${wine.varietal || '-'}</value></div>
                        <div><label>Region</label><value>${wine.region || '-'}</value></div>
                        ${wine.subRegion ? `<div><label>Sub-Region</label><value>${wine.subRegion}</value></div>` : '<div></div>'}
                        <div><label>Type</label><value>${wine.type || '-'}</value></div>
                    </div>
                    
                    ${wine.tastingNotes ? `
                        <div class="wine-tasting-preview">${wine.tastingNotes}</div>
                    ` : '<div class="wine-tasting-preview empty">No tasting notes available</div>'}
                    
                    <div class="wine-status">
                        <span class="status-badge ${status.className}">${status.label}</span>
                        ${wine.communityScore ? `<span class="wine-score">${formatScore(wine.communityScore)}</span>` : ''}
                    </div>
                    
                    ${foodPairings.length > 0 ? `
                        <div class="food-pairings">
                            ${foodPairings.map(food => `<span class="food-tag">${food}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="wine-quantity">
                        <span>In Cellar:<strong>${wine.quantity || 0}</strong></span>
                        ${parseInt(wine.quantityConsumed) > 0 ? `<span>Consumed:<strong>${wine.quantityConsumed}</strong></span>` : ''}
                    </div>
                    
                    ${isExpanded ? renderExpandedDetails(wine) : ''}
                    
                    <div class="wine-actions">
                        <button class="btn-more" onclick="toggleExpand(${wine.id})">${isExpanded ? 'Less' : 'More'}</button>
                        ${parseInt(wine.quantity) > 0 ? `<button class="btn-drink" onclick="consumeBottle(${wine.id})">Drink</button>` : ''}
                        <button class="btn-edit" onclick="openEditModal(${wine.id})">Edit</button>
                        <button class="btn-delete" onclick="deleteWine(${wine.id})">Delete</button>
                    </div>
                </div>
            `;
        }

        function renderExpandedDetails(wine) {
            return `
                <div class="expanded-details">
                    <div class="detail-row">
                        ${wine.country ? `<div><label>Country</label><value>${wine.country}</value></div>` : ''}
                        ${wine.appellation ? `<div><label>Appellation</label><value>${wine.appellation}</value></div>` : ''}
                    </div>
                    
                    ${wine.drinkWindowStart && wine.drinkWindowStart !== '9999' ? `
                        <div class="detail-row">
                            <div><label>Drinking Window</label><value>${wine.drinkWindowStart} - ${wine.drinkWindowEnd}</value></div>
                            ${wine.storageLocation ? `<div><label>Storage Location</label><value>${wine.storageLocation}</value></div>` : ''}
                        </div>
                    ` : wine.storageLocation ? `
                        <div class="detail-row">
                            <div><label>Storage Location</label><value>${wine.storageLocation}</value></div>
                        </div>
                    ` : ''}
                    
                    ${wine.currentValue ? `
                        <div class="detail-row">
                            <div><label>Current Value</label><value>SGD ${parseFloat(wine.currentValue).toFixed(2)}</value></div>
                        </div>
                    ` : ''}
                    
                    ${wine.personalNotes ? `
                        <div class="notes-box">
                            <label>Personal Notes</label>
                            <div>${wine.personalNotes}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderError(message) {
            document.getElementById('app').innerHTML = `
                <div class="error">
                    <h2>Connection Error</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">${message}</p>
                    <div class="error-details">
                        <strong style="color: var(--accent-light);">Checklist:</strong><br>
                        • Apps Script has CORS headers<br>
                        • Deployment "Who has access" = "Anyone"<br>
                        • Sheet tab named "WineCellar"<br>
                        • Data imported
                    </div>
                    <button class="btn" onclick="loadWines()">Retry Connection</button>
                </div>
            `;
        }

        function handleSearch(value) {
            searchTerm = value;
            filterAndSortWines();
            renderApp();
        }

        function handleFilterType(value) {
            filterType = value;
            filterAndSortWines();
            renderApp();
        }

        function handleSort(value) {
            sortBy = value;
            filterAndSortWines();
            renderApp();
        }

        function toggleFilters() {
            showFilters = !showFilters;
            renderApp();
        }

        function handleFoodFilter(food, checked) {
            if (checked) {
                selectedFoodPairings.push(food);
            } else {
                selectedFoodPairings = selectedFoodPairings.filter(f => f !== food);
            }
            filterAndSortWines();
            renderApp();
        }

        function toggleExpand(id) {
            expandedWineId = expandedWineId === id ? null : id;
            renderApp();
        }

        async function consumeBottle(id) {
            if (!confirm('Mark one bottle as consumed?')) return;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'consume', id: id })
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                await loadWines();
            } catch (err) {
                alert(`Failed to consume bottle: ${err.message}`);
            }
        }

        async function deleteWine(id) {
            if (!confirm('Are you sure you want to delete this wine?')) return;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'delete', id: id })
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                await loadWines();
            } catch (err) {
                alert(`Failed to delete wine: ${err.message}`);
            }
        }

        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            document.getElementById('addForm').reset();
        }

        async function handleAddWine(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const wineData = {};
            
            for (let [key, value] of formData.entries()) {
                if (key !== 'foodPairing') {
                    wineData[key] = value;
                }
            }
            
            const foodPairings = formData.getAll('foodPairing');
            wineData.foodPairings = foodPairings.join(', ');
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'add', wine: wineData })
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                closeAddModal();
                await loadWines();
            } catch (err) {
                alert(`Failed to add wine: ${err.message}`);
            }
        }

        function openEditModal(id) {
            const wine = wines.find(w => w.id === id);
            if (!wine) return;
            
            document.getElementById('editId').value = wine.id;
            document.getElementById('editWineName').value = wine.wineName || '';
            document.getElementById('editProducer').value = wine.producer || '';
            document.getElementById('editVintage').value = wine.vintage || '';
            document.getElementById('editVarietal').value = wine.varietal || '';
            document.getElementById('editType').value = wine.type || 'Red';
            document.getElementById('editQuantity').value = wine.quantity || 0;
            document.getElementById('editCountry').value = wine.country || '';
            document.getElementById('editRegion').value = wine.region || '';
            document.getElementById('editSubRegion').value = wine.subRegion || '';
            document.getElementById('editAppellation').value = wine.appellation || '';
            document.getElementById('editDrinkStart').value = wine.drinkWindowStart || '';
            document.getElementById('editDrinkEnd').value = wine.drinkWindowEnd || '';
            document.getElementById('editStorageLocation').value = wine.storageLocation || '';
            document.getElementById('editPhotoUrl').value = wine.photoUrl || '';
            document.getElementById('editTastingNotes').value = wine.tastingNotes || '';
            document.getElementById('editPersonalNotes').value = wine.personalNotes || '';
            
            const foodPairings = wine.foodPairings ? wine.foodPairings.split(',').map(f => f.trim()) : [];
            document.querySelectorAll('#editFoodPairings input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = foodPairings.includes(checkbox.value);
            });
            
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('editForm').reset();
        }

        async function handleEditWine(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const wineData = {};
            const id = formData.get('id');
            
            for (let [key, value] of formData.entries()) {
                if (key !== 'foodPairing' && key !== 'id') {
                    wineData[key] = value;
                }
            }
            
            const foodPairings = formData.getAll('foodPairing');
            wineData.foodPairings = foodPairings.join(', ');
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'update', id: parseInt(id), wine: wineData })
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                closeEditModal();
                await loadWines();
            } catch (err) {
                alert(`Failed to update wine: ${err.message}`);
            }
        }

        function openCsvModal() {
            document.getElementById('csvModal').classList.add('active');
        }

        function closeCsvModal() {
            document.getElementById('csvModal').classList.remove('active');
            document.getElementById('csvInput').value = '';
        }

        async function handleCsvImport() {
            const csvText = document.getElementById('csvInput').value.trim();
            if (!csvText) {
                alert('Please paste CSV data');
                return;
            }
            
            try {
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                const wines = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = lines[i].split(',').map(v => v.trim());
                    const wine = {};
                    
                    headers.forEach((header, index) => {
                        wine[header] = values[index] || '';
                    });
                    
                    wines.push(wine);
                }
                
                let successCount = 0;
                for (const wine of wines) {
                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'add', wine: wine })
                        });
                        
                        const data = await response.json();
                        if (!data.error) successCount++;
                    } catch (err) {
                        console.error('Failed to import wine:', wine.wineName, err);
                    }
                }
                
                alert(`Successfully imported ${successCount} of ${wines.length} wines`);
                closeCsvModal();
                await loadWines();
                
            } catch (err) {
                alert(`Failed to parse CSV: ${err.message}`);
            }
        }
    </script>
</body>
</html>
